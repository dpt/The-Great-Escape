<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at 9D7B</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="The Great Escape" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="9D78.html">9D78</a>
</td>
<td class="up">Up: <a href="../maps/all.html#9d7b">Map</a></td>
<td class="next">
Next: <a href="9DCF.html">9DCF</a>
</td>
</tr>
</table>
<div class="description">9D7B: Main loop</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
This is the main game loop.
</div>
<div class="paragraph">
Unlike in higher-level languages The Great Escape's calling convention is not always strictly hierarchical. At points in the game where a reset or transition is required (see <a href="68A2.html">transition</a>, <a href="68F4.html">enter_room</a>) the game will "give up" and call <a href="691A.html">squash_stack_goto_main</a>. It will reset the stack pointer and jump to this main loop.
</div>
<div class="paragraph">
Used by the routine at <a href="691A.html">squash_stack_goto_main</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">main_loop</td>
<td class="address-2"><span id="9d7b"></span>9D7B</td>
<td class="instruction">CALL <a href="9DCF.html">check_morale</a></td>
<td class="comment-1" rowspan="1">Check morale level, report if (near) zero and inhibit player control if exhausted</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9d7e"></span>9D7E</td>
<td class="instruction">CALL <a href="9DE5.html">keyscan_break</a></td>
<td class="comment-1" rowspan="1">Check for a BREAK keypress</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9d81"></span>9D81</td>
<td class="instruction">CALL <a href="7D48.html">message_display</a></td>
<td class="comment-1" rowspan="1">Incrementally wipe and display queued game messages</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9d84"></span>9D84</td>
<td class="instruction">CALL <a href="9E07.html">process_player_input</a></td>
<td class="comment-1" rowspan="1">Process player input</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9d87"></span>9D87</td>
<td class="instruction">CALL <a href="9F21.html">in_permitted_area</a></td>
<td class="comment-1" rowspan="1">Check the hero's map position and colour the flag accordingly</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9d8a"></span>9D8A</td>
<td class="instruction">CALL <a href="BB98.html">restore_tiles</a></td>
<td class="comment-1" rowspan="1">Paint any tiles occupied by visible characters with tiles from tile_buf</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9d8d"></span>9D8D</td>
<td class="instruction">CALL <a href="C6A0.html">move_a_character</a></td>
<td class="comment-1" rowspan="1">Move a character around</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9d90"></span>9D90</td>
<td class="instruction">CALL <a href="C892.html">automatics</a></td>
<td class="comment-1" rowspan="1">Make characters follow the hero if he's being suspicious</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9d93"></span>9D93</td>
<td class="instruction">CALL <a href="C47E.html">purge_invisible_characters</a></td>
<td class="comment-1" rowspan="1">Run through all visible characters, resetting them if they're off-screen</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9d96"></span>9D96</td>
<td class="instruction">CALL <a href="C41C.html">spawn_characters</a></td>
<td class="comment-1" rowspan="1">Spawn characters</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9d99"></span>9D99</td>
<td class="instruction">CALL <a href="DB9E.html">mark_nearby_items</a></td>
<td class="comment-1" rowspan="1">Mark nearby items</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9d9c"></span>9D9C</td>
<td class="instruction">CALL <a href="A09E.html">ring_bell</a></td>
<td class="comment-1" rowspan="1">Ring the alarm bell (1)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9d9f"></span>9D9F</td>
<td class="instruction">CALL <a href="B5CE.html">animate</a></td>
<td class="comment-1" rowspan="1">Animate all visible characters</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9da2"></span>9DA2</td>
<td class="instruction">CALL <a href="AAB2.html">move_map</a></td>
<td class="comment-1" rowspan="1">Move the map when the hero walks</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9da5"></span>9DA5</td>
<td class="instruction">CALL <a href="7D48.html">message_display</a></td>
<td class="comment-1" rowspan="1">Incrementally wipe and display queued game messages</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9da8"></span>9DA8</td>
<td class="instruction">CALL <a href="A09E.html">ring_bell</a></td>
<td class="comment-1" rowspan="1">Ring the alarm bell (2)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9dab"></span>9DAB</td>
<td class="instruction">CALL <a href="B866.html">plot_sprites</a></td>
<td class="comment-1" rowspan="1">Plot vischars and items in order</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9dae"></span>9DAE</td>
<td class="instruction">CALL <a href="EED3.html">plot_game_window</a></td>
<td class="comment-1" rowspan="1">Plot the game screen</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9db1"></span>9DB1</td>
<td class="instruction">CALL <a href="A09E.html">ring_bell</a></td>
<td class="comment-1" rowspan="1">Ring the alarm bell (3)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9db4"></span>9DB4</td>
<td class="instruction">LD A,($A146)</td>
<td class="comment-1" rowspan="3">If the night-time flag is set, turns white screen elements light blue and tracks the hero with a searchlight</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9db7"></span>9DB7</td>
<td class="instruction">AND A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9db8"></span>9DB8</td>
<td class="instruction">CALL NZ,<a href="ADBD.html">nighttime</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9dbb"></span>9DBB</td>
<td class="instruction">LD A,($68A0)</td>
<td class="comment-1" rowspan="3">If the global current room index is non-zero then slow the game down with a delay loop</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9dbe"></span>9DBE</td>
<td class="instruction">AND A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9dbf"></span>9DBF</td>
<td class="instruction">CALL NZ,<a href="A095.html">interior_delay_loop</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9dc2"></span>9DC2</td>
<td class="instruction">CALL <a href="A035.html">wave_morale_flag</a></td>
<td class="comment-1" rowspan="1">Wave the morale flag</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9dc5"></span>9DC5</td>
<td class="instruction">LD A,($A12F)</td>
<td class="comment-1" rowspan="3">Dispatch a timed event event once every 64 ticks of the game counter</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9dc8"></span>9DC8</td>
<td class="instruction">AND $3F</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9dca"></span>9DCA</td>
<td class="instruction">CALL Z,<a href="A1A0.html">dispatch_timed_event</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9dcd"></span>9DCD</td>
<td class="instruction">JR <a href="9D7B.html#9d7b">main_loop</a></td>
<td class="comment-1" rowspan="1">...loop forever</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="9D78.html">9D78</a>
</td>
<td class="up">Up: <a href="../maps/all.html#9d7b">Map</a></td>
<td class="next">
Next: <a href="9DCF.html">9DCF</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete The Great Escape disassembly 20240104</div>
<div class="copyright">&copy; 1986 Denton Designs &amp; Ocean Software Ltd. (The Great Escape). &copy; 2012-2024 David Thomas (this disassembly).</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.0.</div>
</footer>
</body>
</html>