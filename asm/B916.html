<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at B916</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="The Great Escape" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="B89C.html">B89C</a></span></td>
<td class="up">Up: <a href="../maps/all.html#b916">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="BACD.html">BACD</a></span></td>
</tr>
</table>
<div class="description">B916: Render the mask buffer.</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
The game uses a series of RLE encoded masks to characters to cut away pixels belonging to foreground objects. This ensures that characters aren't drawn atop of walls, huts and fences. This routine works out which masks intersect with the current player position then overlays them into the mask buffer at $8100.
</div>
<div class="paragraph">
At 32x40 pixels the mask buffer is small: sized to fit a single character.
</div>
<div class="paragraph">
Used by the routine at <a href="B866.html">plot_sprites</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b916"></span>
<div class="comments">
<div class="paragraph">
Set all the bits in the mask buffer at $8100..$819F. A clear bit in this buffer means transparent; a set bit means opaque.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer</td>
<td class="address-2"><span id="b916"></span>B916</td>
<td class="instruction">LD HL,$8100</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the mask buffer</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b919"></span>B919</td>
<td class="instruction">LD (HL),$FF</td>
<td class="comment-11" rowspan="1">Set its first byte to $FF</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b91b"></span>B91B</td>
<td class="instruction">LD DE,$8101</td>
<td class="comment-11" rowspan="3">Do a rolling fill: copy the first byte to the second and so on until the buffer is filled</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b91e"></span>B91E</td>
<td class="instruction">LD BC,$009F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b921"></span>B921</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b923"></span>B923</td>
<td class="instruction">LD A,($68A0)</td>
<td class="comment-11" rowspan="1">Get the global current room index</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b926"></span>B926</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Are we outdoors?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b927"></span>B927</td>
<td class="instruction">JR Z,<a href="B916.html#b935">rmb_outdoors</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b929"></span>
<div class="comments">
<div class="paragraph">
We're indoors - use the interior mask structures.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">rmb_indoors</td>
<td class="address-1"><span id="b929"></span>B929</td>
<td class="instruction">LD HL,$81DA</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at interior_mask_data_count</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b92c"></span>B92C</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Fetch the count of interior masks</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b92d"></span>B92D</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is the count zero?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b92e"></span>B92E</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return if so - there are no masks to render</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b92f"></span>B92F</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1"><span class="register">B</span> is now our outermost loop counter</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b930"></span>B930</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="4">Point <span class="register">HL</span> at interior_mask_data[0] + 2 bytes (mask.bounds.x1)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b931"></span>B931</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b932"></span>B932</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b933"></span>B933</td>
<td class="instruction">JR <a href="B916.html#b93a">rmb_per_mask_loop</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b935"></span>
<div class="comments">
<div class="paragraph">
We're outdoors - use the exterior mask structures.
</div>
<div class="paragraph">
Bug: The mask count of 59 here doesn't match the length of exterior_mask_data[] which is only 58 entries long.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">rmb_outdoors</td>
<td class="address-2"><span id="b935"></span>B935</td>
<td class="instruction">LD B,$3B</td>
<td class="comment-11" rowspan="1">Set <span class="register">B</span> for 59 iterations</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b937"></span>B937</td>
<td class="instruction">LD HL,$EC03</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at exterior_mask_data[0] + 2 bytes (mask.bounds.x1)</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b93a"></span>
<div class="comments">
<div class="paragraph">
Fill the mask buffer with the union of all matching masks.
</div>
<div class="paragraph">
Skip any masks which don't overlap the character. 'mask.bounds' is a bounding on the map image (in isometric projected map space). 'mask.pos' is a map coordinate (in map space). We use these to cull those masks which don't intersect with the character being rendered and those which are behind the character on the map.
</div>
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">rmb_per_mask_loop</td>
<td class="address-2"><span id="b93a"></span>B93A</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Preserve the mask loop counter</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b93b"></span>B93B</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Preserve the mask data pointer</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b93c"></span>
<div class="comments">
<div class="paragraph">
X axis part.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b93c"></span>B93C</td>
<td class="instruction">LD A,($81B5)</td>
<td class="comment-11" rowspan="2">Compute iso_pos_x - 1</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b93f"></span>B93F</td>
<td class="instruction">DEC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b940"></span>
<div class="comments">
<div class="paragraph">
Reject if the vischar's left edge is beyond the mask's right edge.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b940"></span>B940</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Is (iso_pos_x - 1) &gt;= mask.bounds.x1?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b941"></span>B941</td>
<td class="instruction">JP NC,<a href="B916.html#bac3">rmb_pop_next</a></td>
<td class="comment-11" rowspan="1">Jump if so (process the next mask)</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b944"></span>
<div class="comments">
<div class="paragraph">
Reject if the vischar's right edge is beyond the mask's left edge.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b944"></span>B944</td>
<td class="instruction">ADD A,$04</td>
<td class="comment-11" rowspan="1">Compute (iso_pos_x - 1) + 4</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b946"></span>B946</td>
<td class="instruction">DEC HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at mask.bounds.x0</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b947"></span>B947</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Is (iso_pos_x - 1) + 4 &lt; mask.bounds.x0?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b948"></span>B948</td>
<td class="instruction">JP C,<a href="B916.html#bac3">rmb_pop_next</a></td>
<td class="comment-11" rowspan="1">Jump if so (process the next mask)</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b94b"></span>
<div class="comments">
<div class="paragraph">
Y axis part.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b94b"></span>B94B</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="3">Point <span class="register">HL</span> at mask.bounds.y1</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b94c"></span>B94C</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b94d"></span>B94D</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b94e"></span>B94E</td>
<td class="instruction">LD A,($81B6)</td>
<td class="comment-11" rowspan="2">Compute iso_pos_y - 1</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b951"></span>B951</td>
<td class="instruction">DEC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b952"></span>
<div class="comments">
<div class="paragraph">
Reject if the vischar's top edge is beyond the mask's bottom edge.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b952"></span>B952</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Is (iso_pos_y - 1) &gt;= mask.bounds.y1?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b953"></span>B953</td>
<td class="instruction">JP NC,<a href="B916.html#bac3">rmb_pop_next</a></td>
<td class="comment-11" rowspan="1">Jump if so (process the next mask)</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b956"></span>
<div class="comments">
<div class="paragraph">
Reject if the vischar's bottom edge is beyond the mask's top edge.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b956"></span>B956</td>
<td class="instruction">ADD A,$05</td>
<td class="comment-11" rowspan="1">Compute (iso_pos_y - 1) + 5</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b958"></span>B958</td>
<td class="instruction">DEC HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at mask.bounds.y0</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b959"></span>B959</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Is (iso_pos_y - 1) + 5 &lt; mask.bounds.y0?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b95a"></span>B95A</td>
<td class="instruction">JP C,<a href="B916.html#bac3">rmb_pop_next</a></td>
<td class="comment-11" rowspan="1">Jump if so (process the next mask)</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b95d"></span>
<div class="comments">
<div class="paragraph">
Skip masks which the character is in front of. A character is in front of a mask when either of its coordinates are less than mask.pos.
</div>
<div class="paragraph">
tinypos_stash contains the vischar's mi.pos scaled as required.
</div>
<div class="paragraph">
Reject if the character's X coordinate is not beyond mask.pos.x.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b95d"></span>B95D</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="2">Advance <span class="register">HL</span> to mask.pos.x</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b95e"></span>B95E</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b95f"></span>B95F</td>
<td class="instruction">LD A,($81B2)</td>
<td class="comment-11" rowspan="1">Fetch tinypos_stash_x</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b962"></span>B962</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Is tinypos_stash_x &lt;= mask.pos.x?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b963"></span>B963</td>
<td class="instruction">JP Z,<a href="B916.html#bac3">rmb_pop_next</a></td>
<td class="comment-11" rowspan="1">Jump if equal</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b966"></span>B966</td>
<td class="instruction">JP C,<a href="B916.html#bac3">rmb_pop_next</a></td>
<td class="comment-11" rowspan="1">Or jump if less than</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b969"></span>
<div class="comments">
<div class="paragraph">
Reject if the character's Y coordinate is not beyond mask.pos.y.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b969"></span>B969</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Advance <span class="register">HL</span> to mask.pos.y</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b96a"></span>B96A</td>
<td class="instruction">LD A,($81B3)</td>
<td class="comment-11" rowspan="1">Fetch tinypos_stash_y</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b96d"></span>B96D</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Is tinypos_stash_y &lt; mask.pos.y?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b96e"></span>B96E</td>
<td class="instruction">JP C,<a href="B916.html#bac3">rmb_pop_next</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b971"></span>
<div class="comments">
<div class="paragraph">
Reject if the character's height is beyond mask.pos.height.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b971"></span>B971</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Advance <span class="register">HL</span> to mask.pos.height</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b972"></span>B972</td>
<td class="instruction">LD A,($81B4)</td>
<td class="comment-11" rowspan="1">Fetch tinypos_stash_height</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b975"></span>B975</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="3">If tinypos_stash_height is non-zero: add one</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b976"></span>B976</td>
<td class="instruction">JR Z,<a href="B916.html#b979">render_mask_buffer_0</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b978"></span>B978</td>
<td class="instruction">DEC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer_0</td>
<td class="address-2"><span id="b979"></span>B979</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Is tinypos_stash_height &gt;= mask.pos.height?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b97a"></span>B97A</td>
<td class="instruction">JP NC,<a href="B916.html#bac3">rmb_pop_next</a></td>
<td class="comment-11" rowspan="1">Jump if so (process the next mask)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b97d"></span>B97D</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="5">Step <span class="register">HL</span> back to mask.bounds.x0</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b97e"></span>B97E</td>
<td class="instruction">SUB $06</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b980"></span>B980</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b981"></span>B981</td>
<td class="instruction">JR NC,<a href="B916.html#b984">render_mask_buffer_1</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b983"></span>B983</td>
<td class="instruction">DEC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b984"></span>
<div class="comments">
<div class="paragraph">
The mask is valid: now calculate the clipped dimensions.
</div>
<div class="paragraph">
X axis part.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer_1</td>
<td class="address-2"><span id="b984"></span>B984</td>
<td class="instruction">LD A,($81B5)</td>
<td class="comment-11" rowspan="1">Fetch iso_pos_x</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b987"></span>B987</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Copy it to <span class="register">C</span> for use later</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b988"></span>B988</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Is iso_pos_x &gt;= mask.bounds.x0?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b989"></span>B989</td>
<td class="instruction">JP C,<a href="B916.html#b99f">render_mask_buffer_3</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b98c"></span>
<div class="comments">
<div class="paragraph">
If we arrive here then mask.bounds.x0 is to the left of iso_pos_x. This means that the mask starts beyond the left edge of our render buffer.
</div>
<div class="paragraph">
Set mask_left_skip to &lt;left hand skip&gt; and mask_run_width to &lt;maximum width???&gt;.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b98c"></span>B98C</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="2">Set left hand skip to (iso_pos_x - mask.bounds.x0)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b98d"></span>B98D</td>
<td class="instruction">LD ($B837),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b990"></span>B990</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Advance <span class="register">HL</span> to mask.bounds.x1</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b991"></span>B991</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">Set run width to (mask.bounds.x1 - iso_pos_x)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b992"></span>B992</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b993"></span>B993</td>
<td class="instruction">CP $03</td>
<td class="comment-11" rowspan="4">The run width must not exceed 4 (byte width of the render buffer)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b995"></span>B995</td>
<td class="instruction">JR C,<a href="B916.html#b999">render_mask_buffer_2</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b997"></span>B997</td>
<td class="instruction">LD A,$03</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer_2</td>
<td class="address-2"><span id="b999"></span>B999</td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b99a"></span>B99A</td>
<td class="instruction">LD ($B83A),A</td>
<td class="comment-11" rowspan="1">Store run width (how much of the mask to draw)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b99d"></span>B99D</td>
<td class="instruction">JR <a href="B916.html#b9b6">render_mask_buffer_5</a></td>
<td class="comment-11" rowspan="1">(else)</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b99f"></span>
<div class="comments">
<div class="paragraph">
If we arrive here then mask.bounds.x0 is to the right of iso_pos_x.
</div>
<div class="paragraph">
Set mask_left_skip to zero and mask_run_width to &lt;maximum width???&gt;.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer_3</td>
<td class="address-2"><span id="b99f"></span>B99F</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="1">Fetch mask.bounds.x0</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9a0"></span>B9A0</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="2">Set left hand skip to zero</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9a1"></span>B9A1</td>
<td class="instruction">LD ($B837),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9a4"></span>B9A4</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="6">Calculate maximum remaining space: (iso_pos_x + 4 - mask.bounds.x0)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9a5"></span>B9A5</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9a6"></span>B9A6</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9a7"></span>B9A7</td>
<td class="instruction">LD A,$04</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9a9"></span>B9A9</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9aa"></span>B9AA</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9ab"></span>B9AB</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Advance <span class="register">HL</span> to mask.bounds.x1</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9ac"></span>B9AC</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="3">Calculate total mask width: (mask.bounds.x1 - mask.bounds.x0) + 1</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9ad"></span>B9AD</td>
<td class="instruction">SUB B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9ae"></span>B9AE</td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9af"></span>B9AF</td>
<td class="instruction">CP C</td>
<td class="comment-11" rowspan="3">Choose the minimum of the two possible run widths</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9b0"></span>B9B0</td>
<td class="instruction">JR C,<a href="B916.html#b9b3">render_mask_buffer_4</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9b2"></span>B9B2</td>
<td class="instruction">LD A,C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer_4</td>
<td class="address-2"><span id="b9b3"></span>B9B3</td>
<td class="instruction">LD ($B83A),A</td>
<td class="comment-11" rowspan="1">Store mask_run_width</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b9b6"></span>
<div class="comments">
<div class="paragraph">
Y axis part.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer_5</td>
<td class="address-2"><span id="b9b6"></span>B9B6</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9b7"></span>B9B7</td>
<td class="instruction">LD A,($81B6)</td>
<td class="comment-11" rowspan="1">Fetch iso_pos_y</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9ba"></span>B9BA</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Copy it to <span class="register">C</span> for use later</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9bb"></span>B9BB</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Is iso_pos_y &gt;= mask.bounds.y0?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9bc"></span>B9BC</td>
<td class="instruction">JP C,<a href="B916.html#b9d2">render_mask_buffer_7</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b9bf"></span>
<div class="comments">
<div class="paragraph">
If we arrive here then mask.bounds.y0 is above iso_pos_y. This means that the mask starts beyond the top edge of our render buffer.
</div>
<div class="paragraph">
Set mask_top_skip to &lt;top skip&gt; and mask_run_height to &lt;maximum height???&gt;.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9bf"></span>B9BF</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="2">Set top skip to (iso_pos_y - mask.bounds.y0)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9c0"></span>B9C0</td>
<td class="instruction">LD ($B838),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9c3"></span>B9C3</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Advance <span class="register">HL</span> to mask.bounds.y1</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9c4"></span>B9C4</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">Set run height to (mask.bounds.y1 - iso_pos_y)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9c5"></span>B9C5</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9c6"></span>B9C6</td>
<td class="instruction">CP $04</td>
<td class="comment-11" rowspan="4">The run height must not exceed 5 (UDG height of the render buffer)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9c8"></span>B9C8</td>
<td class="instruction">JR C,<a href="B916.html#b9cc">render_mask_buffer_6</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9ca"></span>B9CA</td>
<td class="instruction">LD A,$04</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer_6</td>
<td class="address-2"><span id="b9cc"></span>B9CC</td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9cd"></span>B9CD</td>
<td class="instruction">LD ($B839),A</td>
<td class="comment-11" rowspan="1">Store run height (how much of the mask to draw)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9d0"></span>B9D0</td>
<td class="instruction">JR <a href="B916.html#b9e9">render_mask_buffer_9</a></td>
<td class="comment-11" rowspan="1">(else)</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b9d2"></span>
<div class="comments">
<div class="paragraph">
If we arrive here then mask.bounds.y0 is below iso_pos_y.
</div>
<div class="paragraph">
Set mask_top_skip to zero and mask_run_height to &lt;maximum height???&gt;.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer_7</td>
<td class="address-2"><span id="b9d2"></span>B9D2</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="1">Fetch mask.bounds.y0</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9d3"></span>B9D3</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="2">Set top skip to zero</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9d4"></span>B9D4</td>
<td class="instruction">LD ($B838),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9d7"></span>B9D7</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="6">Calculate maximum remaining space: (iso_pos_y + 5 - mask.bounds.y0)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9d8"></span>B9D8</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9d9"></span>B9D9</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9da"></span>B9DA</td>
<td class="instruction">LD A,$05</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9dc"></span>B9DC</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9dd"></span>B9DD</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9de"></span>B9DE</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Advance <span class="register">HL</span> to mask.bounds.y1</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9df"></span>B9DF</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="3">Calculate total mask height: (mask.bounds.y1 - mask.bounds.y0) + 1</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9e0"></span>B9E0</td>
<td class="instruction">SUB B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9e1"></span>B9E1</td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9e2"></span>B9E2</td>
<td class="instruction">CP C</td>
<td class="comment-11" rowspan="3">Choose the minimum of the two possible run heights</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9e3"></span>B9E3</td>
<td class="instruction">JR C,<a href="B916.html#b9e6">render_mask_buffer_8</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9e5"></span>B9E5</td>
<td class="instruction">LD A,C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer_8</td>
<td class="address-2"><span id="b9e6"></span>B9E6</td>
<td class="instruction">LD ($B839),A</td>
<td class="comment-11" rowspan="1">Store mask_run_height</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b9e9"></span>
<div class="comments">
<div class="paragraph">
Calculate the initial mask buffer pointer.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer_9</td>
<td class="address-2"><span id="b9e9"></span>B9E9</td>
<td class="instruction">DEC HL</td>
<td class="comment-11" rowspan="1">Step <span class="register">HL</span> back to mask.bounds.y0</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9ea"></span>B9EA</td>
<td class="instruction">LD BC,$0000</td>
<td class="comment-11" rowspan="1">Initialise (x,y) vars to zero</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b9ed"></span>
<div class="comments">
<div class="paragraph">
When the mask has a top or left hand gap, calculate that.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9ed"></span>B9ED</td>
<td class="instruction">LD A,($B838)</td>
<td class="comment-11" rowspan="7">If mask_top_skip is zero, calculate buf_top_skip = (mask.bounds.y0 - iso_pos_y)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9f0"></span>B9F0</td>
<td class="instruction">AND A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9f1"></span>B9F1</td>
<td class="instruction">JR NZ,<a href="B916.html#b9fa">render_mask_buffer_10</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9f3"></span>B9F3</td>
<td class="instruction">LD A,($81B6)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9f6"></span>B9F6</td>
<td class="instruction">NEG</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9f8"></span>B9F8</td>
<td class="instruction">ADD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9f9"></span>B9F9</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer_10</td>
<td class="address-2"><span id="b9fa"></span>B9FA</td>
<td class="instruction">DEC HL</td>
<td class="comment-11" rowspan="2">Step back to mask.bounds.x0</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9fb"></span>B9FB</td>
<td class="instruction">DEC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9fc"></span>B9FC</td>
<td class="instruction">LD A,($B837)</td>
<td class="comment-11" rowspan="7">If mask_left_skip is zero, calculate buf_left_skip = (mask.bounds.x0 - iso_pos_x)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b9ff"></span>B9FF</td>
<td class="instruction">AND A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba00"></span>BA00</td>
<td class="instruction">JR NZ,<a href="B916.html#ba09">render_mask_buffer_11</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba02"></span>BA02</td>
<td class="instruction">LD A,($81B5)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba05"></span>BA05</td>
<td class="instruction">NEG</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba07"></span>BA07</td>
<td class="instruction">ADD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba08"></span>BA08</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer_11</td>
<td class="address-2"><span id="ba09"></span>BA09</td>
<td class="instruction">DEC HL</td>
<td class="comment-11" rowspan="1">Step back to mask.index</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba0a"></span>BA0A</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Load it</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba0b"></span>BA0B</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">Bank it</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="ba0c"></span>
<div class="comments">
<div class="paragraph">
buf_top_skip is in <span class="register">C</span>. buf_left_skip is in <span class="register">B</span>. The multiplier 32 is MASK_BUFFER_ROWBYTES.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba0c"></span>BA0C</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="7">Calculate <span class="register">A</span> = (buf_top_skip * 32 + buf_left_skip)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba0d"></span>BA0D</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba0e"></span>BA0E</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba0f"></span>BA0F</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba10"></span>BA10</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba11"></span>BA11</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba12"></span>BA12</td>
<td class="instruction">ADD A,B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba13"></span>BA13</td>
<td class="instruction">LD HL,$8100</td>
<td class="comment-11" rowspan="3">Add <span class="register">A</span> to mask_buffer to get the mask buffer pointer</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba16"></span>BA16</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba17"></span>BA17</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba18"></span>BA18</td>
<td class="instruction">LD ($81A0),HL</td>
<td class="comment-11" rowspan="1">Save the mask buffer pointer</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba1b"></span>BA1B</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">Unbank index</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba1c"></span>BA1C</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="8">Point <span class="register">DE</span> at mask_pointers[index]</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba1d"></span>BA1D</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba1e"></span>BA1E</td>
<td class="instruction">LD B,$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba20"></span>BA20</td>
<td class="instruction">LD HL,$EBC5</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba23"></span>BA23</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba24"></span>BA24</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba25"></span>BA25</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba26"></span>BA26</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba27"></span>BA27</td>
<td class="instruction">LD HL,($B839)</td>
<td class="comment-11" rowspan="1">Load (<span class="register">L</span>,<span class="register">H</span>) with mask_run_height,mask_run_width</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba2a"></span>BA2A</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="2">Self modify clip height loop</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba2b"></span>BA2B</td>
<td class="instruction">LD ($BA70),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba2e"></span>BA2E</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="2">Self modify clip width loop</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba2f"></span>BA2F</td>
<td class="instruction">LD ($BA72),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba32"></span>BA32</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="3">Self modify mask row skip = (mask width) - mask_run_width</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba33"></span>BA33</td>
<td class="instruction">SUB H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba34"></span>BA34</td>
<td class="instruction">LD ($BA90),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba37"></span>BA37</td>
<td class="instruction">LD A,$20</td>
<td class="comment-11" rowspan="3">Self modify buffer row skip = MASK_BUFFER_ROWBYTES - mask_run_width</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba39"></span>BA39</td>
<td class="instruction">SUB H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba3a"></span>BA3A</td>
<td class="instruction">LD ($BABA),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="ba3d"></span>
<div class="comments">
<div class="paragraph">
Skip the initial clipped mask bytes. The masks are RLE compressed so we can't jump directly to the first byte we need.
</div>
<div class="paragraph">
First, calculate the total number of mask tiles to skip.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba3d"></span>BA3D</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">Preserve mask data pointer</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba3e"></span>BA3E</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="2">Fetch the mask's width</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba3f"></span>BA3F</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba40"></span>BA40</td>
<td class="instruction">LD A,($B838)</td>
<td class="comment-11" rowspan="1">Fetch mask_top_skip</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba43"></span>BA43</td>
<td class="instruction">CALL <a href="BACD.html">multiply</a></td>
<td class="comment-11" rowspan="1">Multiply mask_top_skip by mask_width. Result is returned in <span class="register">HL</span>. Note: <span class="register">D</span> and <span class="register">B</span> are zeroed</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba46"></span>BA46</td>
<td class="instruction">LD A,($B837)</td>
<td class="comment-11" rowspan="2">Fetch mask_left_skip</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba49"></span>BA49</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba4a"></span>BA4A</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-11" rowspan="1">Add mask_left_skip to <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba4b"></span>BA4B</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">Restore mask data pointer</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba4c"></span>BA4C</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">+ 1 [Explain]</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="ba4d"></span>
<div class="comments">
<div class="paragraph">
Next, loop until we've stepped over that number of mask tiles.
</div>
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">rmb_more_to_skip</td>
<td class="address-2"><span id="ba4d"></span>BA4D</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Read a byte. It could be a repeat count or a tile index</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba4e"></span>BA4E</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is the MASK_RUN_FLAG set?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba4f"></span>BA4F</td>
<td class="instruction">JP P,<a href="B916.html#ba60">rmb_skipping_index</a></td>
<td class="comment-11" rowspan="1">Jump if clear: it's a tile index (JP P =&gt; positive)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba52"></span>BA52</td>
<td class="instruction">AND $7F</td>
<td class="comment-11" rowspan="1">Otherwise mask it off, giving the repeat count</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba54"></span>BA54</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">Advance the mask data pointer (over the count)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba55"></span>BA55</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="2">Decrease mask_skip by repeat count (<span class="register">B</span> is zeroed by <a href="BACD.html">multiply</a> call above)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba56"></span>BA56</td>
<td class="instruction">SBC HL,BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba58"></span>BA58</td>
<td class="instruction">JR C,<a href="B916.html#ba69">rmb_skip_went_negative</a></td>
<td class="comment-11" rowspan="1">Jump if it went negative</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba5a"></span>BA5A</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">Otherwise advance the mask data pointer (over the value) (doesn't affect flags)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba5b"></span>BA5B</td>
<td class="instruction">JR NZ,<a href="B916.html#ba4d">rmb_more_to_skip</a></td>
<td class="comment-11" rowspan="1">...loop while mask_skip &gt; 0</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba5d"></span>BA5D</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">Otherwise mask_skip must be zero. Zero the counter</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba5e"></span>BA5E</td>
<td class="instruction">JR <a href="B916.html#ba6c">rmb_start_drawing</a></td>
<td class="comment-11" rowspan="1">Jump to rmb_start_drawing</td>
</tr>
<tr>
<td class="asm-label-1">rmb_skipping_index</td>
<td class="address-2"><span id="ba60"></span>BA60</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">Advance the mask data pointer</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba61"></span>BA61</td>
<td class="instruction">DEC HL</td>
<td class="comment-11" rowspan="1">Decrement mask_skip</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba62"></span>BA62</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="3">...loop while mask_skip &gt; 0</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba63"></span>BA63</td>
<td class="instruction">OR H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba64"></span>BA64</td>
<td class="instruction">JP NZ,<a href="B916.html#ba4d">rmb_more_to_skip</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba67"></span>BA67</td>
<td class="instruction">JR <a href="B916.html#ba6c">rmb_start_drawing</a></td>
<td class="comment-11" rowspan="1">Jump to rmb_start_drawing</td>
</tr>
<tr>
<td class="asm-label-1">rmb_skip_went_negative</td>
<td class="address-2"><span id="ba69"></span>BA69</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="1">How far did we overshoot?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba6a"></span>BA6A</td>
<td class="instruction">NEG</td>
<td class="comment-11" rowspan="1">Negate it to create a positive mask emit(?) count</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="ba6c"></span>
<div class="comments">
<div class="paragraph">
<span class="register">A</span> = Count of blocks to emit <span class="register">DE</span> = Points to a value (if -ve case) .. but the upcoming code expects a flag byte...
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">rmb_start_drawing</td>
<td class="address-2"><span id="ba6c"></span>BA6C</td>
<td class="instruction">LD HL,($81A0)</td>
<td class="comment-11" rowspan="1">Get the mask buffer pointer</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba6f"></span>BA6F</td>
<td class="instruction">LD C,$01</td>
<td class="comment-11" rowspan="1">Set <span class="register">C</span> for (self modified height) iterations</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="ba71"></span>
<div class="comments">
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer_12</td>
<td class="address-2"><span id="ba71"></span>BA71</td>
<td class="instruction">LD B,$01</td>
<td class="comment-11" rowspan="1">Set <span class="register">B</span> for (self modified width) iterations</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="ba73"></span>
<div class="comments">
<div class="paragraph">
Start loop
</div>
<div class="paragraph">
DPT: The banking of <span class="register">A</span> is hard to follow here. It's difficult to see if this section is entered with a skip value whether it will be handled correctly.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer_13</td>
<td class="address-2"><span id="ba73"></span>BA73</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">Bank the &lt;repeat length&gt;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba74"></span>BA74</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Read a byte. It could be a repeat count or a tile index</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba75"></span>BA75</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is the MASK_RUN_FLAG set?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba76"></span>BA76</td>
<td class="instruction">JP P,<a href="B916.html#ba7e">render_mask_buffer_14</a></td>
<td class="comment-11" rowspan="1">Jump if clear: it's a tile index (JP P =&gt; positive)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba79"></span>BA79</td>
<td class="instruction">AND $7F</td>
<td class="comment-11" rowspan="1">Otherwise mask it off, giving the repeat count</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba7b"></span>BA7B</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">Bank the repeat count; unbank the &lt;repeat length&gt;  REPLACING IT?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba7c"></span>BA7C</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">Advance the mask data pointer</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba7d"></span>BA7D</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Read the next byte (a tile)</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="ba7e"></span>
<div class="comments">
<div class="paragraph">
Shortcut tile 0 which is blank.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer_14</td>
<td class="address-2"><span id="ba7e"></span>BA7E</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is it tile zero?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba7f"></span>BA7F</td>
<td class="instruction">CALL NZ,<a href="BADC.html">mask_against_tile</a></td>
<td class="comment-11" rowspan="1">Call mask_against_tile if not</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba82"></span>BA82</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Advance mask buffer pointer (a tile was written)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba83"></span>BA83</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">Unbank the repeat count OR &lt;repeat length&gt;  CONFUSING</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="ba84"></span>
<div class="comments">
<div class="paragraph">
Advance the mask pointer when the repeat count reaches zero.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba84"></span>BA84</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is it zero?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba85"></span>BA85</td>
<td class="instruction">JR Z,<a href="B916.html#ba8b">render_mask_buffer_15</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba87"></span>BA87</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="1">Otherwise decrement the repeat count</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba88"></span>BA88</td>
<td class="instruction">JR Z,<a href="B916.html#ba8b">render_mask_buffer_15</a></td>
<td class="comment-11" rowspan="1">Jump if it hit zero</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba8a"></span>BA8A</td>
<td class="instruction">DEC DE</td>
<td class="comment-11" rowspan="1">Otherwise undo the next instruction</td>
</tr>
<tr>
<td class="asm-label-1">render_mask_buffer_15</td>
<td class="address-2"><span id="ba8b"></span>BA8B</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">Advance the mask data pointer</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba8c"></span>BA8C</td>
<td class="instruction">DJNZ <a href="B916.html#ba73">render_mask_buffer_13</a></td>
<td class="comment-11" rowspan="1">...loop (width)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba8e"></span>BA8E</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Preserve the loop counter (<span class="register">B</span> will be zero here, <span class="register">C</span> = y)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba8f"></span>BA8F</td>
<td class="instruction">LD B,$01</td>
<td class="comment-11" rowspan="1">Set <span class="register">B</span> for (self modified, right hand skip) iterations</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba91"></span>BA91</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">Bank the repeat count while we test <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba92"></span>BA92</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="2">Is the right hand skip zero?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba93"></span>BA93</td>
<td class="instruction">AND A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba94"></span>BA94</td>
<td class="instruction">JP Z,<a href="B916.html#bab9">rmb_next_line</a></td>
<td class="comment-11" rowspan="1">Jump if so (process next mask)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba97"></span>BA97</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">Unbank the repeat count</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba98"></span>BA98</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is it zero?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba99"></span>BA99</td>
<td class="instruction">JR NZ,<a href="B916.html#baa3">rmb_trailskip_dive_in</a></td>
<td class="comment-11" rowspan="1">Jump if not: (CHECK) must be continuing with a nonzero repeat count</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="ba9b"></span>
<div class="comments">
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">rmb_trailskip_more_to_skip</td>
<td class="address-2"><span id="ba9b"></span>BA9B</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Read a byte. It could be a repeat count or a tile index</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba9c"></span>BA9C</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is the MASK_RUN_FLAG set?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="ba9d"></span>BA9D</td>
<td class="instruction">JP P,<a href="B916.html#baaf">rmb_something</a></td>
<td class="comment-11" rowspan="1">Jump if clear: it's a tile index (JP P =&gt; positive)</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="baa0"></span>
<div class="comments">
<div class="paragraph">
It's a repeat.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="baa0"></span>BAA0</td>
<td class="instruction">AND $7F</td>
<td class="comment-11" rowspan="1">Otherwise mask it off, giving the repeat count</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="baa2"></span>BAA2</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">Advance the mask data pointer</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="baa3"></span>
<div class="comments">
<div class="paragraph">
(resume point)
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">rmb_trailskip_dive_in</td>
<td class="address-2"><span id="baa3"></span>BAA3</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="4">right_skip = A = (right_skip - A)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="baa4"></span>BAA4</td>
<td class="instruction">LD A,B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="baa5"></span>BAA5</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="baa6"></span>BAA6</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="baa7"></span>BAA7</td>
<td class="instruction">JR C,<a href="B916.html#bab6">rmb_trailskip_negative</a></td>
<td class="comment-11" rowspan="1">Jump if it went negative</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="baa9"></span>BAA9</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">Advance the mask data pointer (doesn't affect flags)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="baaa"></span>BAAA</td>
<td class="instruction">JR NZ,<a href="B916.html#ba9b">rmb_trailskip_more_to_skip</a></td>
<td class="comment-11" rowspan="1">if (right_skip &gt; 0) goto START OF LOOP</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="baac"></span>BAAC</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">bank // could jump $BAB8 instead</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="baad"></span>BAAD</td>
<td class="instruction">JR <a href="B916.html#bab9">rmb_next_line</a></td>
<td class="comment-11" rowspan="1">Otherwise right_skip must be zero, jump to rmb_next_line</td>
</tr>
<tr>
<td class="asm-label-1">rmb_something</td>
<td class="address-2"><span id="baaf"></span>BAAF</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">Advance the mask data pointer</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="bab0"></span>BAB0</td>
<td class="instruction">DJNZ <a href="B916.html#ba9b">rmb_trailskip_more_to_skip</a></td>
<td class="comment-11" rowspan="1">...loop</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="bab2"></span>BAB2</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">Reset counter (WHAT IS IT?)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="bab3"></span>BAB3</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">bank // could jump $BAB8 instead</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="bab4"></span>BAB4</td>
<td class="instruction">JR <a href="B916.html#bab9">rmb_next_line</a></td>
<td class="comment-11" rowspan="1">Jump to rmb_next_line</td>
</tr>
<tr>
<td class="asm-label-1">rmb_trailskip_negative</td>
<td class="address-2"><span id="bab6"></span>BAB6</td>
<td class="instruction">NEG</td>
<td class="comment-11" rowspan="1">Negate it to create a positive mask emit(?) count</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="bab8"></span>BAB8</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">bank</td>
</tr>
<tr>
<td class="asm-label-1">rmb_next_line</td>
<td class="address-2"><span id="bab9"></span>BAB9</td>
<td class="instruction">LD A,$20</td>
<td class="comment-11" rowspan="3">Advance <span class="register">HL</span> by (self modified skip)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="babb"></span>BABB</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="babc"></span>BABC</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="babd"></span>BABD</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">Unbank the &lt;repeat length&gt; (re-banked when loop continues)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="babe"></span>BABE</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore the height counter</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="babf"></span>BABF</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="2">...loop (height)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="bac0"></span>BAC0</td>
<td class="instruction">JP NZ,<a href="B916.html#ba71">render_mask_buffer_12</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">rmb_pop_next</td>
<td class="address-2"><span id="bac3"></span>BAC3</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the mask data pointer</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="bac4"></span>BAC4</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore the mask loop counter</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="bac5"></span>BAC5</td>
<td class="instruction">LD DE,$0008</td>
<td class="comment-11" rowspan="2">Advance <span class="register">HL</span> to the next mask_t</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="bac8"></span>BAC8</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="bac9"></span>BAC9</td>
<td class="instruction">DEC B</td>
<td class="comment-11" rowspan="2">...loop</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="baca"></span>BACA</td>
<td class="instruction">JP NZ,<a href="B916.html#b93a">rmb_per_mask_loop</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">

<div class="comments">
<div class="paragraph">
Bug: The RET instruction is missing from the end of the routine. If unfixed the routine will harmlessly fall through into multiply.
</div>
</div>
</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="B89C.html">B89C</a></span></td>
<td class="up">Up: <a href="../maps/all.html#b916">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="BACD.html">BACD</a></span></td>
</tr>
</table>
<footer>
<div class="release">The nearly complete The Great Escape disassembly 20190312</div>
<div class="copyright">&copy; 1986 Denton Designs &amp; Ocean Software Ltd. (The Great Escape). &copy; 2012-2019 David Thomas (this disassembly).</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 7.1.</div>
</footer>
</body>
</html>