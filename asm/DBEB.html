<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at DBEB</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="The Great Escape" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="DB9E.html">DB9E</a>
</td>
<td class="up">Up: <a href="../maps/all.html#dbeb">Map</a></td>
<td class="next">
Next: <a href="DC41.html">DC41</a>
</td>
</tr>
</table>
<div class="description">DBEB: Get next drawable itemstruct</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
This finds the next item to draw that is furthest behind (x,y).
</div>
<div class="paragraph">
Used by the routine at <a href="B89C.html">get_next_drawable</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A'</td>
<td class="register-desc">A value to leave in <span class="register">A'</span> when nothing is found (e.g. 255)</td>
</tr>
<tr>
<td class="register">BC'</td>
<td class="register-desc">X position</td>
</tr>
<tr>
<td class="register">DE'</td>
<td class="register-desc">Y position</td>
</tr>
</table>
<table class="output">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>
<tr>
<td class="register">A'</td>
<td class="register-desc">Index of the greatest item with the item_FOUND flag set, if found</td>
</tr>
<tr>
<td class="register">IY</td>
<td class="register-desc">Pointer to an itemstruct, if found</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">get_next_drawable_itemstruct</td>
<td class="address-2"><span id="dbeb"></span>DBEB</td>
<td class="instruction">LD BC,$1007</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> for 16 iterations (item__LIMIT) and set <span class="register">C</span> for a seven byte stride simultaneously</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dbee"></span>DBEE</td>
<td class="instruction">LD HL,$76C9</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the first item_struct's room member</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="dbf1"></span>
<div class="comments">
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ggi_loop</td>
<td class="address-2"><span id="dbf1"></span>DBF1</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">Is the itemstruct_ROOM_FLAG_ITEM_NEARBY_7 flag set? ($80)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dbf3"></span>DBF3</td>
<td class="instruction">JR Z,<a href="DBEB.html#dc38">ggi_next</a></td>
<td class="comment-1" rowspan="1">If not, jump to the next iteration</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dbf5"></span>DBF5</td>
<td class="instruction">BIT 6,(HL)</td>
<td class="comment-1" rowspan="1">Is the itemstruct_ROOM_FLAG_ITEM_NEARBY_6 flag set? ($40)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dbf7"></span>DBF7</td>
<td class="instruction">JR Z,<a href="DBEB.html#dc38">ggi_next</a></td>
<td class="comment-1" rowspan="1">If not, jump to the next iteration</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dbf9"></span>DBF9</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Preserve the item_struct pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dbfa"></span>DBFA</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Preserve the item counter and stride</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="dbfb"></span>
<div class="comments">
<div class="paragraph">
Select an item if it's behind the point (x,y).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dbfb"></span>DBFB</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to item_struct.pos.x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dbfc"></span>DBFC</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch item_struct.pos.x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dbfd"></span>DBFD</td>
<td class="instruction">CALL <a href="B1C7.html">multiply_by_8</a></td>
<td class="comment-1" rowspan="1">Multiply it by 8 returning the result in <span class="register">BC</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc00"></span>DC00</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Preserve the result</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc01"></span>DC01</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Flip to banked regs - so we can subtract X position</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc02"></span>DC02</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the result into <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc03"></span>DC03</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Clear the carry flag prior to SBC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc04"></span>DC04</td>
<td class="instruction">SBC HL,BC</td>
<td class="comment-1" rowspan="1">Calculate (item_struct.pos.x * 8 - x_position)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc06"></span>DC06</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Flip to unbanked regs - now we have the result</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc07"></span>DC07</td>
<td class="instruction">JR Z,<a href="DBEB.html#dc36">ggi_next_pop</a></td>
<td class="comment-1" rowspan="1">Was (item_struct.pos.x * 8 &lt;= x_position)?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc09"></span>DC09</td>
<td class="instruction">JR C,<a href="DBEB.html#dc36">ggi_next_pop</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc0b"></span>DC0B</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to item_struct.pos.y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc0c"></span>DC0C</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch item_struct.pos.y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc0d"></span>DC0D</td>
<td class="instruction">CALL <a href="B1C7.html">multiply_by_8</a></td>
<td class="comment-1" rowspan="1">Multiply it by 8 returning the result in <span class="register">BC</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc10"></span>DC10</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Preserve the result</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc11"></span>DC11</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Flip to banked regs - so we can subtract Y position</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc12"></span>DC12</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the result into <span class="register">HL</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="dc13"></span>
<div class="comments">
<div class="paragraph">
Q. Why are we not clearing the carry flag like at <a href="DBEB.html#dc03">DC03</a>?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc13"></span>DC13</td>
<td class="instruction">SBC HL,DE</td>
<td class="comment-1" rowspan="1">Calculate (item_struct.pos.y * 8 - y_position)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc15"></span>DC15</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Flip to unbanked regs - now we have the result</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc16"></span>DC16</td>
<td class="instruction">JR Z,<a href="DBEB.html#dc36">ggi_next_pop</a></td>
<td class="comment-1" rowspan="1">Was (item_struct.pos.y * 8 &lt;= y_position)?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc18"></span>DC18</td>
<td class="instruction">JR C,<a href="DBEB.html#dc36">ggi_next_pop</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc1a"></span>DC1A</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Preserve the item_struct pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc1b"></span>DC1B</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Flip to banked regs - so we can store new X,Y positions</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc1c"></span>DC1C</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the item_struct pointer</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="dc1d"></span>
<div class="comments">
<div class="paragraph">
Calculate (x,y) for the next iteration.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc1d"></span>DC1D</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch item_struct.pos.y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc1e"></span>DC1E</td>
<td class="instruction">CALL <a href="B1C7.html">multiply_by_8</a></td>
<td class="comment-1" rowspan="1">Multiply it by 8 returning the result in <span class="register">BC</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc21"></span>DC21</td>
<td class="instruction">LD E,C</td>
<td class="comment-1" rowspan="2"><span class="register">DE</span> = <span class="register">BC</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc22"></span>DC22</td>
<td class="instruction">LD D,B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc23"></span>DC23</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Rewind <span class="register">HL</span> to point at item_struct.pos.x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc24"></span>DC24</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch item_struct.pos.x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc25"></span>DC25</td>
<td class="instruction">CALL <a href="B1C7.html">multiply_by_8</a></td>
<td class="comment-1" rowspan="1">Multiply it by 8 returning the result in <span class="register">BC</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc28"></span>DC28</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="2">Rewind <span class="register">HL</span> to point at item_struct (jump back over item &amp; room bytes)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc29"></span>DC29</td>
<td class="instruction">DEC HL</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="dc2a"></span>
<div class="comments">
<div class="paragraph">
<span class="register">IY</span> is used to return an item_struct here which is unusual compared to the rest of the code which maintains <span class="register">IY</span> as a current vischar pointer.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc2a"></span>DC2A</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="2">Copy the item_struct pointer to <span class="register">IY</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc2b"></span>DC2B</td>
<td class="instruction">POP IY</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc2d"></span>DC2D</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Flip to unbanked regs</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc2e"></span>DC2E</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the item counter and stride</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc2f"></span>DC2F</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Preserve the item counter and stride</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc30"></span>DC30</td>
<td class="instruction">LD A,$10</td>
<td class="comment-1" rowspan="2">Calculate the item index (item__LIMIT - item counter)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc32"></span>DC32</td>
<td class="instruction">SUB B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc33"></span>DC33</td>
<td class="instruction">OR $40</td>
<td class="comment-1" rowspan="1">Set the item found flag</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc35"></span>DC35</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-1" rowspan="1">Return the value in <span class="register">A'</span></td>
</tr>
<tr>
<td class="asm-label">ggi_next_pop</td>
<td class="address-2"><span id="dc36"></span>DC36</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore item counter and stride</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc37"></span>DC37</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore item_struct pointer</td>
</tr>
<tr>
<td class="asm-label">ggi_next</td>
<td class="address-2"><span id="dc38"></span>DC38</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="5">Advance by stride to next item</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc39"></span>DC39</td>
<td class="instruction">ADD A,L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc3a"></span>DC3A</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc3b"></span>DC3B</td>
<td class="instruction">JR NC,<a href="DBEB.html#dc3e">ggi_loop_end</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc3d"></span>DC3D</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="asm-label">ggi_loop_end</td>
<td class="address-2"><span id="dc3e"></span>DC3E</td>
<td class="instruction">DJNZ <a href="DBEB.html#dbf1">ggi_loop</a></td>
<td class="comment-1" rowspan="1">...loop</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="dc40"></span>DC40</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="DB9E.html">DB9E</a>
</td>
<td class="up">Up: <a href="../maps/all.html#dbeb">Map</a></td>
<td class="next">
Next: <a href="DC41.html">DC41</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete The Great Escape disassembly 20240104</div>
<div class="copyright">&copy; 1986 Denton Designs &amp; Ocean Software Ltd. (The Great Escape). &copy; 2012-2024 David Thomas (this disassembly).</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.0.</div>
</footer>
</body>
</html>