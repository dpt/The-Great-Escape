<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at BAF7</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="The Great Escape" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="BADC.html">BADC</a>
</td>
<td class="up">Up: <a href="../maps/all.html#baf7">Map</a></td>
<td class="next">
Next: <a href="BB98.html">BB98</a>
</td>
</tr>
</table>
<div class="description">BAF7: Vischar visible</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
This clips the given vischar's dimensions to the game window.
</div>
<div class="paragraph">
Used by the routines at <a href="BB98.html">restore_tiles</a> and <a href="E420.html">setup_vischar_plotting</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IY</td>
<td class="register-desc">Pointer to visible character</td>
</tr>
</table>
<table class="output">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">0/255 =&gt; vischar visible/not visible</td>
</tr>
<tr>
<td class="register">B</td>
<td class="register-desc">Lefthand skip (bytes</td>
</tr>
<tr>
<td class="register">C</td>
<td class="register-desc">Clipped width (bytes).</td>
</tr>
<tr>
<td class="register">D</td>
<td class="register-desc">Top skip (rows)</td>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">Clipped height (rows)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="baf7"></span>
<div class="comments">
<div class="paragraph">
To determine visibility and sort out clipping there are five cases to consider per axis: (A) the vischar is completely off the left/top of window, (B) the vischar is clipped on its left/top, (C) the vischar is entirely visible, (D) the vischar is clipped on its right/bottom, and (E) the vischar is completely off the right/bottom of window.
</div>
<div class="paragraph">
Note that no vischar will ever be wider than the window so we never need to consider if clipping will occur on both sides.
</div>
<div class="paragraph">
First handle the horizontal cases.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">vischar_visible</td>
<td class="address-2"><span id="baf7"></span>BAF7</td>
<td class="instruction">LD HL,$81B5</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at iso_pos_x (vischar left edge)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bafa"></span>
<div class="comments">
<div class="paragraph">
Calculate the right edge of the window in map space.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bafa"></span>BAFA</td>
<td class="instruction">LD A,($81BB)</td>
<td class="comment-1" rowspan="1">Load map X position</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bafd"></span>BAFD</td>
<td class="instruction">ADD A,$18</td>
<td class="comment-1" rowspan="1">Add 24 (number of window columns)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="baff"></span>
<div class="comments">
<div class="paragraph">
Subtract iso_pos_x giving the distance between the right edge of the window and the current vischar's left edge (in bytes).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="baff"></span>BAFF</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-1" rowspan="1">available_right = (map_position.x + 24) - vischar_left_edge</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb00"></span>
<div class="comments">
<div class="paragraph">
Check for case (E): Vischar left edge beyond the window's right edge.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb00"></span>BB00</td>
<td class="instruction">JP Z,<a href="BAF7.html#bb94">vv_not_visible</a></td>
<td class="comment-1" rowspan="1">Jump to exit if zero (vischar left edge at right edge)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb03"></span>BB03</td>
<td class="instruction">JP C,<a href="BAF7.html#bb94">vv_not_visible</a></td>
<td class="comment-1" rowspan="1">Jump to exit if negative (vischar left edge beyond right edge)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb06"></span>
<div class="comments">
<div class="paragraph">
Check for case (D): Vischar extends outside the window.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb06"></span>BB06</td>
<td class="instruction">CP (IY+$1E)</td>
<td class="comment-1" rowspan="1">Compare result to (sprite width bytes + 1)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb09"></span>BB09</td>
<td class="instruction">JP NC,<a href="BAF7.html#bb11">vv_not_clipped_on_right_edge</a></td>
<td class="comment-1" rowspan="1">Jump if it fits</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb0c"></span>
<div class="comments">
<div class="paragraph">
Vischar's right edge is outside the window: clip its width.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb0c"></span>BB0C</td>
<td class="instruction">LD B,$00</td>
<td class="comment-1" rowspan="1">No lefthand skip</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb0e"></span>BB0E</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Clipped width = available_right</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb0f"></span>BB0F</td>
<td class="instruction">JR <a href="BAF7.html#bb33">vv_height</a></td>
<td class="comment-1" rowspan="1">Jump to height part</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb11"></span>
<div class="comments">
<div class="paragraph">
Calculate the right edge of the vischar.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">vv_not_clipped_on_right_edge</td>
<td class="address-2"><span id="bb11"></span>BB11</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Load iso_pos_x (vischar left edge)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb12"></span>BB12</td>
<td class="instruction">ADD A,(IY+$1E)</td>
<td class="comment-1" rowspan="1">vischar_right_edge = iso_pos_x + (sprite width bytes + 1)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb15"></span>
<div class="comments">
<div class="paragraph">
Subtract the map position's X giving the distance between the current vischar's right edge and the left edge of the window (in bytes).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb15"></span>BB15</td>
<td class="instruction">LD HL,$81BB</td>
<td class="comment-1" rowspan="1">Load map X position</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb18"></span>BB18</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-1" rowspan="1">available_left = vischar_right_edge - map_position.x</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb19"></span>
<div class="comments">
<div class="paragraph">
Check for case (A): Vischar's right edge is beyond the window's left edge.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb19"></span>BB19</td>
<td class="instruction">JP Z,<a href="BAF7.html#bb94">vv_not_visible</a></td>
<td class="comment-1" rowspan="1">Jump to exit if zero (vischar right edge at left edge)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb1c"></span>BB1C</td>
<td class="instruction">JP C,<a href="BAF7.html#bb94">vv_not_visible</a></td>
<td class="comment-1" rowspan="1">Jump to exit if negative (vischar right edge beyond left edge)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb1f"></span>
<div class="comments">
<div class="paragraph">
Check for case (B): Vischar's left edge is outside the window and its right edge is inside the window.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb1f"></span>BB1F</td>
<td class="instruction">CP (IY+$1E)</td>
<td class="comment-1" rowspan="1">Compare result to (sprite width bytes + 1)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb22"></span>BB22</td>
<td class="instruction">JP NC,<a href="BAF7.html#bb2e">vv_not_clipped</a></td>
<td class="comment-1" rowspan="1">Jump if it fits</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb25"></span>
<div class="comments">
<div class="paragraph">
Vischar's left edge is outside the window: move the lefthand skip into <span class="register">B</span> and the clipped width into <span class="register">C</span>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb25"></span>BB25</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Clipped width = available_left</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb26"></span>BB26</td>
<td class="instruction">NEG</td>
<td class="comment-1" rowspan="3">Lefthand skip = (sprite width bytes + 1) - available_left</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb28"></span>BB28</td>
<td class="instruction">ADD A,(IY+$1E)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb2b"></span>BB2B</td>
<td class="instruction">LD B,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb2c"></span>BB2C</td>
<td class="instruction">JR <a href="BAF7.html#bb33">vv_height</a></td>
<td class="comment-1" rowspan="1">(else)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb2e"></span>
<div class="comments">
<div class="paragraph">
Case (C): No clipping required.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">vv_not_clipped</td>
<td class="address-2"><span id="bb2e"></span>BB2E</td>
<td class="instruction">LD B,$00</td>
<td class="comment-1" rowspan="1">No lefthand skip</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb30"></span>BB30</td>
<td class="instruction">LD C,(IY+$1E)</td>
<td class="comment-1" rowspan="1">Clipped width = (sprite width bytes + 1)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb33"></span>
<div class="comments">
<div class="paragraph">
Handle vertical cases.
</div>
<div class="paragraph">
Note: This uses vischar.iso_pos, not state.iso_pos as above.
</div>
<div class="paragraph">
Calculate the bottom edge of the window in map space.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">vv_height</td>
<td class="address-2"><span id="bb33"></span>BB33</td>
<td class="instruction">LD A,($81BC)</td>
<td class="comment-1" rowspan="2">Load the map position's Y and add 17 (number of window rows)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb36"></span>BB36</td>
<td class="instruction">ADD A,$11</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb38"></span>BB38</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="5">Multiply it by 8</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb39"></span>BB39</td>
<td class="instruction">LD H,$00</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb3b"></span>BB3B</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb3c"></span>BB3C</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb3d"></span>BB3D</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb3e"></span>
<div class="comments">
<div class="paragraph">
Subtract vischar's Y giving the distance between the bottom edge of the window and the current vischar's top (in rows).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb3e"></span>BB3E</td>
<td class="instruction">LD E,(IY+$1A)</td>
<td class="comment-1" rowspan="2">Load vischar.iso_pos.y (vischar top edge)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb41"></span>BB41</td>
<td class="instruction">LD D,(IY+$1B)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb44"></span>BB44</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Clear carry flag</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb45"></span>BB45</td>
<td class="instruction">SBC HL,DE</td>
<td class="comment-1" rowspan="1">available_bottom = window_bottom_edge * 8 - vischar-&gt;iso_pos.y</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb47"></span>
<div class="comments">
<div class="paragraph">
Check for case (E): Vischar top edge beyond the window's bottom edge.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb47"></span>BB47</td>
<td class="instruction">JP Z,<a href="BAF7.html#bb94">vv_not_visible</a></td>
<td class="comment-1" rowspan="1">Jump to exit if zero (vischar top edge at bottom edge)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb4a"></span>BB4A</td>
<td class="instruction">JP C,<a href="BAF7.html#bb94">vv_not_visible</a></td>
<td class="comment-1" rowspan="1">Jump to exit if negative (vischar top edge beyond bottom edge)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb4d"></span>BB4D</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="3">Jump to exit if &gt;= 256 (way out of range)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb4e"></span>BB4E</td>
<td class="instruction">AND A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb4f"></span>BB4F</td>
<td class="instruction">JP NZ,<a href="BAF7.html#bb94">vv_not_visible</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb52"></span>
<div class="comments">
<div class="paragraph">
Check for case (D): Vischar extends outside the window.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb52"></span>BB52</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="1"><span class="register">A</span> = available_bottom</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb53"></span>BB53</td>
<td class="instruction">CP (IY+$1F)</td>
<td class="comment-1" rowspan="1">Compare result to vischar.height</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb56"></span>BB56</td>
<td class="instruction">JP NC,<a href="BAF7.html#bb5e">vv_not_clipped_on_top_edge</a></td>
<td class="comment-1" rowspan="1">Jump if it fits (available_top &gt;= vischar.height)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb59"></span>
<div class="comments">
<div class="paragraph">
Vischar's bottom edge is outside the window: clip its height.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb59"></span>BB59</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Clipped height = available_bottom</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb5a"></span>BB5A</td>
<td class="instruction">LD D,$00</td>
<td class="comment-1" rowspan="1">No top skip</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb5c"></span>BB5C</td>
<td class="instruction">JR <a href="BAF7.html#bb92">vv_visible</a></td>
<td class="comment-1" rowspan="1">Jump to exit</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb5e"></span>
<div class="comments">
<div class="paragraph">
Calculate the bottom edge of the vischar.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">vv_not_clipped_on_top_edge</td>
<td class="address-2"><span id="bb5e"></span>BB5E</td>
<td class="instruction">LD L,(IY+$1F)</td>
<td class="comment-1" rowspan="2">Load sprite height and widen</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb61"></span>BB61</td>
<td class="instruction">LD H,$00</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb63"></span>BB63</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-1" rowspan="1">vischar_bottom_edge = vischar.iso_pos.y + (sprite height)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb64"></span>
<div class="comments">
<div class="paragraph">
Subtract map position's Y (scaled) giving the distance between the current vischar's bottom edge and the top edge of the window (in rows).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb64"></span>BB64</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Bank</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb65"></span>BB65</td>
<td class="instruction">LD A,($81BC)</td>
<td class="comment-1" rowspan="3">Load the map position's Y and widen</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb68"></span>BB68</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb69"></span>BB69</td>
<td class="instruction">LD H,$00</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb6b"></span>BB6B</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-1" rowspan="3">Multiply by 8</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb6c"></span>BB6C</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb6d"></span>BB6D</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb6e"></span>BB6E</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Unbank</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb6f"></span>BB6F</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Clear the carry flag</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb70"></span>BB70</td>
<td class="instruction">SBC HL,DE</td>
<td class="comment-1" rowspan="1">available_top = vischar_bottom_edge - map_pos_y * 8</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb72"></span>
<div class="comments">
<div class="paragraph">
Check for case (A): Vischar's bottom edge is beyond the window's top edge.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb72"></span>BB72</td>
<td class="instruction">JP C,<a href="BAF7.html#bb94">vv_not_visible</a></td>
<td class="comment-1" rowspan="1">Jump to exit if negative (vischar bottom edge beyond top edge)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb75"></span>BB75</td>
<td class="instruction">JP Z,<a href="BAF7.html#bb94">vv_not_visible</a></td>
<td class="comment-1" rowspan="1">Jump to exit if zero (vischar bottom edge at top edge)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb78"></span>BB78</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="3">Jump to exit if &gt;= 256 (way out of range)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb79"></span>BB79</td>
<td class="instruction">AND A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb7a"></span>BB7A</td>
<td class="instruction">JP NZ,<a href="BAF7.html#bb94">vv_not_visible</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb7d"></span>
<div class="comments">
<div class="paragraph">
Check for case (B): Vischar's top edge is outside the window and its bottom edge is inside the window.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb7d"></span>BB7D</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="1"><span class="register">A</span> = available_top</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb7e"></span>BB7E</td>
<td class="instruction">CP (IY+$1F)</td>
<td class="comment-1" rowspan="1">Compare result to vischar.height</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb81"></span>BB81</td>
<td class="instruction">JP NC,<a href="BAF7.html#bb8d">vischar_visible_0</a></td>
<td class="comment-1" rowspan="1">Jump if it fits (available_top &gt;= vischar.height)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb84"></span>
<div class="comments">
<div class="paragraph">
Vischar's top edge is outside the window: move the top skip into <span class="register">D</span> and the clipped height into <span class="register">E</span>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb84"></span>BB84</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Clipped height = available_top</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb85"></span>BB85</td>
<td class="instruction">NEG</td>
<td class="comment-1" rowspan="3">Top skip = vischar.height - available_top</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb87"></span>BB87</td>
<td class="instruction">ADD A,(IY+$1F)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb8a"></span>BB8A</td>
<td class="instruction">LD D,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb8b"></span>BB8B</td>
<td class="instruction">JR <a href="BAF7.html#bb92">vv_visible</a></td>
<td class="comment-1" rowspan="1">(else)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="bb8d"></span>
<div class="comments">
<div class="paragraph">
Case (C): No clipping required.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">vischar_visible_0</td>
<td class="address-2"><span id="bb8d"></span>BB8D</td>
<td class="instruction">LD D,$00</td>
<td class="comment-1" rowspan="1">No top skip</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb8f"></span>BB8F</td>
<td class="instruction">LD E,(IY+$1F)</td>
<td class="comment-1" rowspan="1">Clipped height = vischar.height</td>
</tr>
<tr>
<td class="asm-label">vv_visible</td>
<td class="address-2"><span id="bb92"></span>BB92</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set Z (vischar is visible)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb93"></span>BB93</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
<tr>
<td class="asm-label">vv_not_visible</td>
<td class="address-2"><span id="bb94"></span>BB94</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-1" rowspan="1">Signal invisible</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb96"></span>BB96</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Clear Z (vischar is not visible)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="bb97"></span>BB97</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="BADC.html">BADC</a>
</td>
<td class="up">Up: <a href="../maps/all.html#baf7">Map</a></td>
<td class="next">
Next: <a href="BB98.html">BB98</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete The Great Escape disassembly 20210529</div>
<div class="copyright">&copy; 1986 Denton Designs &amp; Ocean Software Ltd. (The Great Escape). &copy; 2012-2021 David Thomas (this disassembly).</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>