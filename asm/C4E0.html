<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at C4E0</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="The Great Escape" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="C47E.html">C47E</a>
</td>
<td class="up">Up: <a href="../maps/all.html#c4e0">Map</a></td>
<td class="next">
Next: <a href="C5D3.html">C5D3</a>
</td>
</tr>
</table>
<div class="description">C4E0: Spawn character</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
This adds a character to the visible character (vischar) list.
</div>
<div class="paragraph">
Used by the routine at <a href="C41C.html">spawn_characters</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">Pointer to character to spawn.</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">spawn_character</td>
<td class="address-2"><span id="c4e0"></span>C4E0</td>
<td class="instruction">BIT 6,(HL)</td>
<td class="comment-1" rowspan="1">Is the character already on-screen? (test flag characterstruct_FLAG_ON_SCREEN)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c4e2"></span>C4E2</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c4e3"></span>C4E3</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Preserve the character pointer</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c4e4"></span>
<div class="comments">
<div class="paragraph">
Find an empty slot in the visible character list.
</div>
<div class="paragraph">
Iterate over non-player characters.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c4e4"></span>C4E4</td>
<td class="instruction">LD HL,$8020</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the second visible character</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c4e7"></span>C4E7</td>
<td class="instruction">LD DE,$0020</td>
<td class="comment-1" rowspan="1">Prepare the vischar stride</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c4ea"></span>C4EA</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-1" rowspan="1">Prepare vischar_CHARACTER_EMPTY_SLOT</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c4ec"></span>C4EC</td>
<td class="instruction">LD B,$07</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> for seven iterations (seven non-player vischars)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c4ee"></span>
<div class="comments">
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">spawn_find_slot</td>
<td class="address-2"><span id="c4ee"></span>C4EE</td>
<td class="instruction">CP (HL)</td>
<td class="comment-1" rowspan="1">Empty slot?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c4ef"></span>C4EF</td>
<td class="instruction">JR Z,<a href="C4E0.html#c4f6">spawn_found_empty_slot</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c4f1"></span>C4F1</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-1" rowspan="1">Advance to the next vischar</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c4f2"></span>C4F2</td>
<td class="instruction">DJNZ <a href="C4E0.html#c4ee">spawn_find_slot</a></td>
<td class="comment-1" rowspan="1">...loop</td>
</tr>
<tr>
<td class="asm-label">spawn_no_spare_slot</td>
<td class="address-1"><span id="c4f4"></span>C4F4</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the character pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c4f5"></span>C4F5</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return (Z set)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c4f6"></span>
<div class="comments">
<div class="paragraph">
Found an empty slot.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">spawn_found_empty_slot</td>
<td class="address-2"><span id="c4f6"></span>C4F6</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore the character pointer to <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c4f7"></span>C4F7</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="2">Point <span class="register">IY</span> at the empty vischar slot</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c4f8"></span>C4F8</td>
<td class="instruction">POP IY</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c4fa"></span>C4FA</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Preserve the empty vischar slot pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c4fb"></span>C4FB</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Preserve the character pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c4fc"></span>C4FC</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Advance <span class="register">DE</span> to point at charstr.room</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c4fd"></span>
<div class="comments">
<div class="paragraph">
Scale coords dependent on which room the character is in.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c4fd"></span>C4FD</td>
<td class="instruction">LD HL,$81A4</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at saved_pos_x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c500"></span>C500</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Fetch charstr.room</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c501"></span>C501</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Advance <span class="register">DE</span> to charstr.pos</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c502"></span>C502</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is it outside?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c503"></span>C503</td>
<td class="instruction">JR NZ,<a href="C4E0.html#c518">spawn_indoors</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c505"></span>
<div class="comments">
<div class="paragraph">
Outdoors
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c505"></span>C505</td>
<td class="instruction">LD A,$03</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> for three iterations (x,y,height)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c507"></span>
<div class="comments">
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">spawn_outdoor_pos_loop</td>
<td class="address-2"><span id="c507"></span>C507</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-1" rowspan="1">Bank</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c508"></span>C508</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Read an (8-bit) coord</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c509"></span>C509</td>
<td class="instruction">CALL <a href="B1C7.html">multiply_by_8</a></td>
<td class="comment-1" rowspan="1">Multiply it by 8 returning the result in <span class="register">BC</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c50c"></span>C50C</td>
<td class="instruction">LD (HL),C</td>
<td class="comment-1" rowspan="4">Store the result widened to 16-bit</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c50d"></span>C50D</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c50e"></span>C50E</td>
<td class="instruction">LD (HL),B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c50f"></span>C50F</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c510"></span>C510</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Advance to the next coord</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c511"></span>C511</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-1" rowspan="1">Unbank</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c512"></span>C512</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="2">...loop</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c513"></span>C513</td>
<td class="instruction">JP NZ,<a href="C4E0.html#c507">spawn_outdoor_pos_loop</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c516"></span>C516</td>
<td class="instruction">JR <a href="C4E0.html#c523">spawn_check_collide</a></td>
<td class="comment-1" rowspan="1">(else)</td>
</tr>
<tr>
<td class="asm-label">spawn_indoors</td>
<td class="address-2"><span id="c518"></span>C518</td>
<td class="instruction">LD B,$03</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> for three iterations</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c51a"></span>
<div class="comments">
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">spawn_indoor_pos_loop</td>
<td class="address-2"><span id="c51a"></span>C51A</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Read an (8-bit) coord</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c51b"></span>C51B</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="5">Store the coord widened to 16-bit</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c51c"></span>C51C</td>
<td class="instruction">INC DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c51d"></span>C51D</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c51e"></span>C51E</td>
<td class="instruction">LD (HL),$00</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c520"></span>C520</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c521"></span>C521</td>
<td class="instruction">DJNZ <a href="C4E0.html#c51a">spawn_indoor_pos_loop</a></td>
<td class="comment-1" rowspan="1">...loop</td>
</tr>
<tr>
<td class="asm-label">spawn_check_collide</td>
<td class="address-2"><span id="c523"></span>C523</td>
<td class="instruction">CALL <a href="AFDF.html">collision</a></td>
<td class="comment-1" rowspan="1">Call collision</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c526"></span>C526</td>
<td class="instruction">CALL Z,<a href="B14C.html">bounds_check</a></td>
<td class="comment-1" rowspan="1">If no collision, call bounds_check</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c529"></span>C529</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore the character pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c52a"></span>C52A</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the empty vischar slot pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c52b"></span>C52B</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if collision or bounds_check returned non-zero</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c52c"></span>
<div class="comments">
<div class="paragraph">
Transfer character struct to vischar.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c52c"></span>C52C</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="3">Set characterstruct_FLAG_ON_SCREEN in charstr.character_and_flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c52d"></span>C52D</td>
<td class="instruction">OR $40</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c52f"></span>C52F</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c530"></span>C530</td>
<td class="instruction">AND $1F</td>
<td class="comment-1" rowspan="3">Mask <span class="register">A</span> against characterstruct_CHARACTER_MASK ($1F) and store that as vischar.character</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c532"></span>C532</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c533"></span>C533</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c534"></span>C534</td>
<td class="instruction">LD (HL),$00</td>
<td class="comment-1" rowspan="1">Clear the vischar.flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c536"></span>C536</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Preserve the charstr.character_and_flags pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c537"></span>C537</td>
<td class="instruction">LD DE,$CD9A</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the character_meta_data for the commandant</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c53a"></span>C53A</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is it character_0_COMMANDANT?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c53b"></span>C53B</td>
<td class="instruction">JR Z,<a href="C4E0.html#c54e">spawn_metadata_set</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c53d"></span>C53D</td>
<td class="instruction">LD DE,$CD9E</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the character_meta_data for a guard</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c540"></span>C540</td>
<td class="instruction">CP $10</td>
<td class="comment-1" rowspan="1">Is it character_1_GUARD_1 to character_15_GUARD_15?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c542"></span>C542</td>
<td class="instruction">JR C,<a href="C4E0.html#c54e">spawn_metadata_set</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c544"></span>C544</td>
<td class="instruction">LD DE,$CDA2</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the character_meta_data for a dog</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c547"></span>C547</td>
<td class="instruction">CP $14</td>
<td class="comment-1" rowspan="1">Is it character_16_GUARD_DOG_1 to character_19_GUARD_DOG_4?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c549"></span>C549</td>
<td class="instruction">JR C,<a href="C4E0.html#c54e">spawn_metadata_set</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c54b"></span>C54B</td>
<td class="instruction">LD DE,$CDA6</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the character_meta_data for a prisoner</td>
</tr>
<tr>
<td class="asm-label">spawn_metadata_set</td>
<td class="address-2"><span id="c54e"></span>C54E</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Swap vischar into <span class="register">DE</span>, metadata into <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c54f"></span>C54F</td>
<td class="instruction">LD A,$07</td>
<td class="comment-1" rowspan="3">Point <span class="register">DE</span> at vischar.animbase</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c551"></span>C551</td>
<td class="instruction">ADD A,E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c552"></span>C552</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c553"></span>C553</td>
<td class="instruction">LDI</td>
<td class="comment-1" rowspan="2">Copy metadata.animbase to vischar.animbase</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c555"></span>C555</td>
<td class="instruction">LDI</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c557"></span>C557</td>
<td class="instruction">LD A,$0B</td>
<td class="comment-1" rowspan="3">Point <span class="register">DE</span> at vischar.mi.sprite</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c559"></span>C559</td>
<td class="instruction">ADD A,E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c55a"></span>C55A</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c55b"></span>C55B</td>
<td class="instruction">LDI</td>
<td class="comment-1" rowspan="2">Copy metadata.sprite to vischar.mi.sprite</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c55d"></span>C55D</td>
<td class="instruction">LDI</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c55f"></span>C55F</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="3">Rewind <span class="register">DE</span> to vischar.mi.pos</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c560"></span>C560</td>
<td class="instruction">SUB $08</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c562"></span>C562</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c563"></span>C563</td>
<td class="instruction">LD HL,$81A4</td>
<td class="comment-1" rowspan="3">Copy saved_pos to vischar.mi.pos</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c566"></span>C566</td>
<td class="instruction">LD BC,$0006</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c569"></span>C569</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c56b"></span>C56B</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the <span class="register">HL</span> charstr.character_and_flags pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c56c"></span>C56C</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="5">Advance <span class="register">HL</span> to charstr.route</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c56d"></span>C56D</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c56e"></span>C56E</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c56f"></span>C56F</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c570"></span>C570</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c571"></span>C571</td>
<td class="instruction">LD A,$07</td>
<td class="comment-1" rowspan="3">Point <span class="register">DE</span> at vischar.room</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c573"></span>C573</td>
<td class="instruction">ADD A,E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c574"></span>C574</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c575"></span>C575</td>
<td class="instruction">LD A,($68A0)</td>
<td class="comment-1" rowspan="2">Set vischar.room to the global current room index</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c578"></span>C578</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c579"></span>C579</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Are we outside?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c57a"></span>C57A</td>
<td class="instruction">JR Z,<a href="C4E0.html#c588">spawn_entered</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label">spawn_indoors_sound</td>
<td class="address-1"><span id="c57c"></span>C57C</td>
<td class="instruction">LD BC,$2040</td>
<td class="comment-1" rowspan="4">Play the "character enters" sound effects</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c57f"></span>C57F</td>
<td class="instruction">CALL <a href="A11D.html">play_speaker</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c582"></span>C582</td>
<td class="instruction">LD BC,$2030</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c585"></span>C585</td>
<td class="instruction">CALL <a href="A11D.html">play_speaker</a></td>
</tr>
<tr>
<td class="asm-label">spawn_entered</td>
<td class="address-2"><span id="c588"></span>C588</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="3">Rewind <span class="register">DE</span> to vischar.route</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c589"></span>C589</td>
<td class="instruction">SUB $1A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c58b"></span>C58B</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c58c"></span>C58C</td>
<td class="instruction">LDI</td>
<td class="comment-1" rowspan="2">vischar.route = charstr.route</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c58e"></span>C58E</td>
<td class="instruction">LDI</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c590"></span>C590</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="2">Rewind <span class="register">HL</span> to charstr.route</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c591"></span>C591</td>
<td class="instruction">DEC HL</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c592"></span>
<div class="comments">
<div class="paragraph">
This can get entered twice via <a href="C4E0.html#c5b4">C5B4</a>. On the first entry <span class="register">HL</span> points at charstr.route.index. On the second entry <span class="register">HL</span> points at vischar.route.index.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">spawn_again</td>
<td class="address-2"><span id="c592"></span>C592</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Load route.index</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c593"></span>C593</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is this character stood still? (routeindex_0_HALT)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c594"></span>C594</td>
<td class="instruction">JR NZ,<a href="C4E0.html#c59c">spawn_moving</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c596"></span>C596</td>
<td class="instruction">LD A,$03</td>
<td class="comment-1" rowspan="3">Advance <span class="register">DE</span> to vischar.counter_and_flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c598"></span>C598</td>
<td class="instruction">ADD A,E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c599"></span>C599</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c59a"></span>C59A</td>
<td class="instruction">JR <a href="C4E0.html#c5c4">spawn_end</a></td>
<td class="comment-1" rowspan="1">(else)</td>
</tr>
<tr>
<td class="asm-label">spawn_moving</td>
<td class="address-2"><span id="c59c"></span>C59C</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Clear the entered_move_a_character flag</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c59d"></span>C59D</td>
<td class="instruction">LD ($A13E),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5a0"></span>C5A0</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Preserve the vischar.target pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5a1"></span>C5A1</td>
<td class="instruction">CALL <a href="C651.html">get_target</a></td>
<td class="comment-1" rowspan="1">Get our next target: a location, a door or 'route ends'. The result is returned in <span class="register">A</span>, target pointer returned in <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5a4"></span>C5A4</td>
<td class="instruction">CP $FF</td>
<td class="comment-1" rowspan="1">Did <a href="C651.html">get_target</a> return get_target_ROUTE_ENDS? ($FF)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5a6"></span>C5A6</td>
<td class="instruction">JR NZ,<a href="C4E0.html#c5b6">spawn_route_door_test</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label">spawn_route_ends</td>
<td class="address-1"><span id="c5a8"></span>C5A8</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the vischar.target pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5a9"></span>C5A9</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="2">Rewind <span class="register">HL</span> to vischar.route</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5aa"></span>C5AA</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5ab"></span>C5AB</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Preserve the vischar.route pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5ac"></span>C5AC</td>
<td class="instruction">CALL <a href="CB2D.html">route_ended</a></td>
<td class="comment-1" rowspan="1">Route ended</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5af"></span>C5AF</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the vischar.route pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5b0"></span>C5B0</td>
<td class="instruction">LD D,H</td>
<td class="comment-1" rowspan="4">Point <span class="register">DE</span> at vischar.target</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5b1"></span>C5B1</td>
<td class="instruction">LD E,L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5b2"></span>C5B2</td>
<td class="instruction">INC E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5b3"></span>C5B3</td>
<td class="instruction">INC E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5b4"></span>C5B4</td>
<td class="instruction">JR <a href="C4E0.html#c592">spawn_again</a></td>
<td class="comment-1" rowspan="1">Jump back and try again...</td>
</tr>
<tr>
<td class="asm-label">spawn_route_door_test</td>
<td class="address-2"><span id="c5b6"></span>C5B6</td>
<td class="instruction">CP $80</td>
<td class="comment-1" rowspan="1">Did <a href="C651.html">get_target</a> return get_target_DOOR? ($80)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5b8"></span>C5B8</td>
<td class="instruction">JR NZ,<a href="C4E0.html#c5be">spawn_got_target</a></td>
<td class="comment-1" rowspan="1">Jump if not (it must be get_target_LOCATION)</td>
</tr>
<tr>
<td class="asm-label">spawn_route_door</td>
<td class="address-1"><span id="c5ba"></span>C5BA</td>
<td class="instruction">SET 6,(IY+$01)</td>
<td class="comment-1" rowspan="1">Set the vischar_FLAGS_TARGET_IS_DOOR flag</td>
</tr>
<tr>
<td class="asm-label">spawn_got_target</td>
<td class="address-2"><span id="c5be"></span>C5BE</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore the vischar.target pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5bf"></span>C5BF</td>
<td class="instruction">LD BC,$0003</td>
<td class="comment-1" rowspan="2">Copy the next target to vichar.target</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5c2"></span>C5C2</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="asm-label">spawn_end</td>
<td class="address-2"><span id="c5c4"></span>C5C4</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Clear vischar.counter_and_flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5c5"></span>C5C5</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5c6"></span>C5C6</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="3">Rewind <span class="register">DE</span> back to vischar.character (first byte)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5c7"></span>C5C7</td>
<td class="instruction">SUB $07</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5c9"></span>C5C9</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5ca"></span>C5CA</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Swap vischar pointer into <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5cb"></span>C5CB</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Preserve vischar pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5cc"></span>C5CC</td>
<td class="instruction">CALL <a href="B71B.html">calc_vischar_iso_pos_from_vischar</a></td>
<td class="comment-1" rowspan="1">Calculate screen position for the specified vischar</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5cf"></span>C5CF</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore vischar pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c5d0"></span>C5D0</td>
<td class="instruction">JP <a href="C918.html">character_behaviour</a></td>
<td class="comment-1" rowspan="1">Exit via character_behaviour</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="C47E.html">C47E</a>
</td>
<td class="up">Up: <a href="../maps/all.html#c4e0">Map</a></td>
<td class="next">
Next: <a href="C5D3.html">C5D3</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete The Great Escape disassembly 20210529</div>
<div class="copyright">&copy; 1986 Denton Designs &amp; Ocean Software Ltd. (The Great Escape). &copy; 2012-2021 David Thomas (this disassembly).</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>