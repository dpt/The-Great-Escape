<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at A3BB</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="The Great Escape" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="A38C.html">A38C</a>
</td>
<td class="up">Up: <a href="../maps/all.html#a3bb">Map</a></td>
<td class="next">
Next: <a href="A3ED.html">A3ED</a>
</td>
</tr>
</table>
<div class="description">A3BB: Set route</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
This fetches the current target coordinates using <a href="C651.html">get_target</a> then assigns the result into the vischar (<span class="register">HL</span>).
</div>
<div class="paragraph">
Used by the routine at <a href="A33F.html">set_hero_route</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">Points to route.step.</td>
</tr>
</table>
<table class="output">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>
<tr>
<td class="register">BC</td>
<td class="register-desc">Preserved.</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">set_route</td>
<td class="address-2"><span id="a3bb"></span>A3BB</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Clear the entered_move_a_character flag so that the vischar pointed to by <span class="register">IY</span> is used for character events</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3bc"></span>A3BC</td>
<td class="instruction">LD ($A13E),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3bf"></span>A3BF</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Preserve for callers</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3c0"></span>A3C0</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Preserve route.step pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3c1"></span>A3C1</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at route.index</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3c2"></span>A3C2</td>
<td class="instruction">CALL <a href="C651.html">get_target</a></td>
<td class="comment-1" rowspan="1">Get our next target: a location, a door or 'route ends'. The result is returned in <span class="register">A</span>, target pointer returned in <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3c5"></span>A3C5</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore route.step pointer to <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3c6"></span>A3C6</td>
<td class="instruction">INC E</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at vischar.target</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3c7"></span>A3C7</td>
<td class="instruction">LDI</td>
<td class="comment-1" rowspan="2">Copy target across</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3c9"></span>A3C9</td>
<td class="instruction">LDI</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3cb"></span>A3CB</td>
<td class="instruction">CP $FF</td>
<td class="comment-1" rowspan="1">Did <a href="C651.html">get_target</a> return get_target_ROUTE_ENDS? ($FF)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3cd"></span>A3CD</td>
<td class="instruction">JP NZ,<a href="A3BB.html#a3df">set_route_not_end</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="a3d0"></span>
<div class="comments">
<div class="paragraph">
Result was 'route ends'
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3d0"></span>A3D0</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="3">Point <span class="register">DE</span> at the vischar's start</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3d1"></span>A3D1</td>
<td class="instruction">SUB $06</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3d3"></span>A3D3</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3d4"></span>A3D4</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="2">Assign current vischar to <span class="register">IY</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3d5"></span>A3D5</td>
<td class="instruction">POP IY</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3d7"></span>A3D7</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Swap vischar pointer into <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3d8"></span>A3D8</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at route</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3d9"></span>A3D9</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3da"></span>A3DA</td>
<td class="instruction">CALL <a href="CB23.html">get_target_assign_pos</a></td>
<td class="comment-1" rowspan="1">Call get_target_assign_pos so that the end-of-route handling code is invoked if required. Note: This seems like something of a waste as get_target is (appears to be) called again with the same arguments as above</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3dd"></span>A3DD</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3de"></span>A3DE</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="a3df"></span>
<div class="comments">
<div class="paragraph">
Result was a location or a door
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">set_route_not_end</td>
<td class="address-2"><span id="a3df"></span>A3DF</td>
<td class="instruction">CP $80</td>
<td class="comment-1" rowspan="1">Did <a href="C651.html">get_target</a> return get_target_DOOR? ($80)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3e1"></span>A3E1</td>
<td class="instruction">JP NZ,<a href="A3BB.html#a3eb">set_route_exit</a></td>
<td class="comment-1" rowspan="1">Jump if not (it must be get_target_LOCATION)</td>
</tr>
<tr>
<td class="asm-label">set_route_door</td>
<td class="address-1"><span id="a3e4"></span>A3E4</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="3">Point <span class="register">DE</span> at vischar.flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3e5"></span>A3E5</td>
<td class="instruction">SUB $05</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3e7"></span>A3E7</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3e8"></span>A3E8</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Swap vischar pointer into <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3e9"></span>A3E9</td>
<td class="instruction">SET 6,(HL)</td>
<td class="comment-1" rowspan="1">Set the vischar_FLAGS_TARGET_IS_DOOR flag</td>
</tr>
<tr>
<td class="asm-label">set_route_exit</td>
<td class="address-2"><span id="a3eb"></span>A3EB</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="a3ec"></span>A3EC</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="A38C.html">A38C</a>
</td>
<td class="up">Up: <a href="../maps/all.html#a3bb">Map</a></td>
<td class="next">
Next: <a href="A3ED.html">A3ED</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete The Great Escape disassembly 20240104</div>
<div class="copyright">&copy; 1986 Denton Designs &amp; Ocean Software Ltd. (The Great Escape). &copy; 2012-2024 David Thomas (this disassembly).</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.0.</div>
</footer>
</body>
</html>