<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at B79B</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="The Great Escape" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="B75A.html">B75A</a>
</td>
<td class="up">Up: <a href="../maps/all.html#b79b">Map</a></td>
<td class="next">
Next: <a href="B837.html">B837</a>
</td>
</tr>
</table>
<div class="description">B79B: Reset map and characters</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
This resets all visible characters, the game clock, day_or_night flag, general flags, collapsed tunnel objects, locks the gates, resets all beds, clears the mess halls and resets characters.
</div>
<div class="paragraph">
Used by the routines at <a href="B75A.html">reset_game</a> and <a href="CB98.html">solitary</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">reset_map_and_characters</td>
<td class="address-2"><span id="b79b"></span>B79B</td>
<td class="instruction">LD B,$07</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> for seven iterations</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b79d"></span>B79D</td>
<td class="instruction">LD HL,$8020</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the second vischar</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b7a0"></span>
<div class="comments">
<div class="paragraph">
Start loop (iterate over non-player characters)
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">reset_map_and_characters_0</td>
<td class="address-2"><span id="b7a0"></span>B7A0</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Preserve the counter</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7a1"></span>B7A1</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Preserve the vischar pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7a2"></span>B7A2</td>
<td class="instruction">CALL <a href="C5D3.html">reset_visible_character</a></td>
<td class="comment-1" rowspan="1">Reset the visible character</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7a5"></span>B7A5</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the vischar pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7a6"></span>B7A6</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="3">Advance <span class="register">HL</span> to the next vischar (note shortcut)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7a7"></span>B7A7</td>
<td class="instruction">ADD A,$20</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7a9"></span>B7A9</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7aa"></span>B7AA</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the counter</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7ab"></span>B7AB</td>
<td class="instruction">DJNZ <a href="B79B.html#b7a0">reset_map_and_characters_0</a></td>
<td class="comment-1" rowspan="1">...loop</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7ad"></span>B7AD</td>
<td class="instruction">LD A,$07</td>
<td class="comment-1" rowspan="2">Set the game clock to seven [unsure why seven in particular]</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7af"></span>B7AF</td>
<td class="instruction">LD ($A13D),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7b2"></span>B7B2</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Clear the night-time flag</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7b3"></span>B7B3</td>
<td class="instruction">LD ($A146),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7b6"></span>B7B6</td>
<td class="instruction">LD ($8001),A</td>
<td class="comment-1" rowspan="1">Clear the hero's vischar flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7b9"></span>B7B9</td>
<td class="instruction">LD A,$14</td>
<td class="comment-1" rowspan="2">Set the roomdef_50_blocked_tunnel_collapsed_tunnel object to interiorobject_COLLAPSED_TUNNEL_SW_NE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7bb"></span>B7BB</td>
<td class="instruction">LD ($708C),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7be"></span>B7BE</td>
<td class="instruction">LD A,$34</td>
<td class="comment-1" rowspan="2">Set the blocked tunnel boundary</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7c0"></span>B7C0</td>
<td class="instruction">LD ($7077),A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b7c3"></span>
<div class="comments">
<div class="paragraph">
Lock the gates and doors.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7c3"></span>B7C3</td>
<td class="instruction">LD HL,$F05D</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at locked_doors[0]</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7c6"></span>B7C6</td>
<td class="instruction">LD B,$09</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> for nine iterations (nine locked doors)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b7c8"></span>
<div class="comments">
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">reset_map_and_characters_1</td>
<td class="address-2"><span id="b7c8"></span>B7C8</td>
<td class="instruction">SET 7,(HL)</td>
<td class="comment-1" rowspan="2">Set the door_LOCKED flag Advance <span class="register">HL</span> to the next locked door</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7ca"></span>B7CA</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7cb"></span>B7CB</td>
<td class="instruction">DJNZ <a href="B79B.html#b7c8">reset_map_and_characters_1</a></td>
<td class="comment-1" rowspan="1">...loop</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b7cd"></span>
<div class="comments">
<div class="paragraph">
Reset all beds.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7cd"></span>B7CD</td>
<td class="instruction">LD B,$06</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> for six iterations (six beds)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7cf"></span>B7CF</td>
<td class="instruction">LD A,$17</td>
<td class="comment-1" rowspan="1">Preload <span class="register">A</span> with interiorobject_OCCUPIED_BED</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7d1"></span>B7D1</td>
<td class="instruction">LD HL,$6B79</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at beds[0]</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b7d4"></span>
<div class="comments">
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">reset_map_and_characters_2</td>
<td class="address-2"><span id="b7d4"></span>B7D4</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="4">Load the address of the bed object</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7d5"></span>B7D5</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7d6"></span>B7D6</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7d7"></span>B7D7</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7d8"></span>B7D8</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-1" rowspan="1">Set the bed object to interiorobject_OCCUPIED_BED</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7d9"></span>B7D9</td>
<td class="instruction">DJNZ <a href="B79B.html#b7d4">reset_map_and_characters_2</a></td>
<td class="comment-1" rowspan="1">...loop</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b7db"></span>
<div class="comments">
<div class="paragraph">
Clear the mess halls.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7db"></span>B7DB</td>
<td class="instruction">LD A,$0D</td>
<td class="comment-1" rowspan="1">Preload <span class="register">A</span> with interiorobject_EMPTY_BENCH</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7dd"></span>B7DD</td>
<td class="instruction">LD ($6F17),A</td>
<td class="comment-1" rowspan="1">Set to empty roomdef_23_breakfast_bench_A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7e0"></span>B7E0</td>
<td class="instruction">LD ($6F1A),A</td>
<td class="comment-1" rowspan="1">Set to empty roomdef_23_breakfast_bench_B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7e3"></span>B7E3</td>
<td class="instruction">LD ($6F1D),A</td>
<td class="comment-1" rowspan="1">Set to empty roomdef_23_breakfast_bench_C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7e6"></span>B7E6</td>
<td class="instruction">LD ($6F4F),A</td>
<td class="comment-1" rowspan="1">Set to empty roomdef_25_breakfast_bench_D</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7e9"></span>B7E9</td>
<td class="instruction">LD ($6F52),A</td>
<td class="comment-1" rowspan="1">Set to empty roomdef_25_breakfast_bench_E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7ec"></span>B7EC</td>
<td class="instruction">LD ($6F55),A</td>
<td class="comment-1" rowspan="1">Set to empty roomdef_25_breakfast_bench_F</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7ef"></span>B7EF</td>
<td class="instruction">LD ($6F58),A</td>
<td class="comment-1" rowspan="1">Set to empty roomdef_25_breakfast_bench_G</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b7f2"></span>
<div class="comments">
<div class="paragraph">
Reset characters 12..15 (guards) and 20..25 (prisoners).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7f2"></span>B7F2</td>
<td class="instruction">LD DE,$7667</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at character_structs[12].room</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7f5"></span>B7F5</td>
<td class="instruction">LD C,$0A</td>
<td class="comment-1" rowspan="1">Set <span class="register">C</span> for ten iterations</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7f7"></span>B7F7</td>
<td class="instruction">LD HL,$B819</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at character_reset_data[0]</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b7fa"></span>
<div class="comments">
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">reset_map_and_characters_3</td>
<td class="address-2"><span id="b7fa"></span>B7FA</td>
<td class="instruction">LD B,$03</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> for three iterations</td>
</tr>
<tr>
<td class="asm-label">reset_map_and_characters_4</td>
<td class="address-2"><span id="b7fc"></span>B7FC</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="4">Copy a byte and advance</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7fd"></span>B7FD</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7fe"></span>B7FE</td>
<td class="instruction">INC DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b7ff"></span>B7FF</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b800"></span>B800</td>
<td class="instruction">DJNZ <a href="B79B.html#b7fc">reset_map_and_characters_4</a></td>
<td class="comment-1" rowspan="1">...loop</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b802"></span>
<div class="comments">
<div class="paragraph">
<span class="register">DE</span> now points to the height
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b802"></span>B802</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Swap</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b803"></span>
<div class="comments">
<div class="paragraph">
Bug: This is reset to 18 here but the initial value is 24.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b803"></span>B803</td>
<td class="instruction">LD (HL),$12</td>
<td class="comment-1" rowspan="2">Set height to 18 and advance</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b805"></span>B805</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b806"></span>B806</td>
<td class="instruction">LD (HL),$00</td>
<td class="comment-1" rowspan="2">Set route index to zero (halt)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b808"></span>B808</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b809"></span>B809</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="2">Advance to the next character struct</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b80a"></span>B80A</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b80b"></span>B80B</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Swap</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b80c"></span>B80C</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">Get our loop counter</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b80d"></span>B80D</td>
<td class="instruction">CP $07</td>
<td class="comment-1" rowspan="1">Do seven iterations remain?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b80f"></span>B80F</td>
<td class="instruction">JR NZ,<a href="B79B.html#b814">reset_map_and_characters_5</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b811"></span>B811</td>
<td class="instruction">LD DE,$769F</td>
<td class="comment-1" rowspan="1">Otherwise point <span class="register">DE</span> at character_structs[20].room</td>
</tr>
<tr>
<td class="asm-label">reset_map_and_characters_5</td>
<td class="address-2"><span id="b814"></span>B814</td>
<td class="instruction">DEC C</td>
<td class="comment-1" rowspan="2">...loop</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b815"></span>B815</td>
<td class="instruction">JP NZ,<a href="B79B.html#b7fa">reset_map_and_characters_3</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b818"></span>B818</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b819"></span>
<div class="comments">
<div class="paragraph">
Reset data for character_structs.
</div>
<div class="paragraph">
struct { byte room; byte x; byte y; }; // partial of character_struct
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">character_reset_data</td>
<td class="address-1"><span id="b819"></span>B819</td>
<td class="instruction">DEFB $03,$28,$3C</td>
<td class="comment-1" rowspan="1">(room_3_HUT2RIGHT, 40,60) for character 12</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b81c"></span>B81C</td>
<td class="instruction">DEFB $03,$24,$30</td>
<td class="comment-1" rowspan="1">(room_3_HUT2RIGHT, 36,48) for character 13</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b81f"></span>B81F</td>
<td class="instruction">DEFB $05,$28,$3C</td>
<td class="comment-1" rowspan="1">(room_5_HUT3RIGHT, 40,60) for character 14</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b822"></span>B822</td>
<td class="instruction">DEFB $05,$24,$22</td>
<td class="comment-1" rowspan="1">(room_5_HUT3RIGHT, 36,34) for character 15</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b825"></span>B825</td>
<td class="instruction">DEFB $FF,$34,$3C</td>
<td class="comment-1" rowspan="1">(room_NONE,        52,60) for character 20</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b828"></span>B828</td>
<td class="instruction">DEFB $FF,$34,$2C</td>
<td class="comment-1" rowspan="1">(room_NONE,        52,44) for character 21</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b82b"></span>B82B</td>
<td class="instruction">DEFB $FF,$34,$1C</td>
<td class="comment-1" rowspan="1">(room_NONE,        52,28) for character 22</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b82e"></span>B82E</td>
<td class="instruction">DEFB $FF,$34,$3C</td>
<td class="comment-1" rowspan="1">(room_NONE,        52,60) for character 23</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b831"></span>B831</td>
<td class="instruction">DEFB $FF,$34,$2C</td>
<td class="comment-1" rowspan="1">(room_NONE,        52,44) for character 24</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b834"></span>B834</td>
<td class="instruction">DEFB $FF,$34,$1C</td>
<td class="comment-1" rowspan="1">(room_NONE,        52,28) for character 25</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="B75A.html">B75A</a>
</td>
<td class="up">Up: <a href="../maps/all.html#b79b">Map</a></td>
<td class="next">
Next: <a href="B837.html">B837</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete The Great Escape disassembly 20240104</div>
<div class="copyright">&copy; 1986 Denton Designs &amp; Ocean Software Ltd. (The Great Escape). &copy; 2012-2024 David Thomas (this disassembly).</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.0.</div>
</footer>
</body>
</html>