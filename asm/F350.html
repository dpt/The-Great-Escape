<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at F350</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="The Great Escape" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="F335.html">F335</a>
</td>
<td class="up">Up: <a href="../maps/all.html#f350">Map</a></td>
<td class="next">
Next: <a href="F408.html">F408</a>
</td>
</tr>
</table>
<div class="description">F350: Choose keys</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
This wipes the game window, sets its attributes, draws prompts, then sits in a loop waiting for the player to make their key choices. The chosen keys (defined by port and mask) are stored in the table at <a href="F06B.html">keydefs</a>. Finally the user is asked to confirm their key choices.
</div>
<div class="paragraph">
Used by the routine at <a href="F271.html">check_menu_keys</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f350"></span>
<div class="comments">
<div class="paragraph">
Start loop (infinite) - loops until the user confirms the key selection.
</div>
<div class="paragraph">
Clear the game window.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">choose_keys</td>
<td class="address-2"><span id="f350"></span>F350</td>
<td class="instruction">CALL <a href="F335.html">wipe_game_window</a></td>
<td class="comment-1" rowspan="1">Wipe the game screen</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f353"></span>F353</td>
<td class="instruction">LD A,$07</td>
<td class="comment-1" rowspan="2">Set game window attributes to attribute_WHITE_OVER_BLACK</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f355"></span>F355</td>
<td class="instruction">CALL <a href="A15F.html">set_game_window_attributes</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f358"></span>
<div class="comments">
<div class="paragraph">
Draw key choice prompts.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f358"></span>F358</td>
<td class="instruction">LD B,$06</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> for six iterations</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f35a"></span>F35A</td>
<td class="instruction">LD HL,$F2AD</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at define_key_prompts</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f35d"></span>
<div class="comments">
<div class="paragraph">
Start loop (once per prompt)
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ck_prompts_loop</td>
<td class="address-2"><span id="f35d"></span>F35D</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Preserve the loop counter</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f35e"></span>F35E</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="4">Read screen address</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f35f"></span>F35F</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f360"></span>F360</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f361"></span>F361</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f362"></span>F362</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-1" rowspan="2">Read string length</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f363"></span>F363</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f364"></span>
<div class="comments">
<div class="paragraph">
Draw the prompt's glyphs.
</div>
<div class="paragraph">
Start loop (once per character)
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ck_draw_prompt</td>
<td class="address-2"><span id="f364"></span>F364</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Preserve string length</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f365"></span>
<div class="comments">
<div class="paragraph">
Bug: The next load is needless (plot_glyph does it already).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f365"></span>F365</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Read a glyph</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f366"></span>F366</td>
<td class="instruction">CALL <a href="7D2F.html">plot_glyph</a></td>
<td class="comment-1" rowspan="1">Plot a single glyph (indirectly)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f369"></span>F369</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance the string pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f36a"></span>F36A</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore string length</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f36b"></span>F36B</td>
<td class="instruction">DJNZ <a href="F350.html#f364">ck_draw_prompt</a></td>
<td class="comment-1" rowspan="1">...loop (once per character)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f36d"></span>F36D</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the loop counter</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f36e"></span>F36E</td>
<td class="instruction">DJNZ <a href="F350.html#f35d">ck_prompts_loop</a></td>
<td class="comment-1" rowspan="1">...loop (once per prompt)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f370"></span>
<div class="comments">
<div class="paragraph">
Wipe key definitions.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f370"></span>F370</td>
<td class="instruction">LD HL,$F06B</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at keydefs</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f373"></span>F373</td>
<td class="instruction">LD B,$0A</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> for 10 iterations</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f375"></span>F375</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Zero <span class="register">A</span> in preparation</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f376"></span>
<div class="comments">
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ck_clear_keydef</td>
<td class="address-2"><span id="f376"></span>F376</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Zero a byte of keydef</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f377"></span>F377</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f378"></span>F378</td>
<td class="instruction">DJNZ <a href="F350.html#f376">ck_clear_keydef</a></td>
<td class="comment-1" rowspan="1">...loop</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f37a"></span>
<div class="comments">
<div class="paragraph">
Now scan for keys.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f37a"></span>F37A</td>
<td class="instruction">LD B,$05</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> for five iterations: left/right/up/down/fire</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f37c"></span>F37C</td>
<td class="instruction">LD HL,$F32B</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at key_name_screen_addrs</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f37f"></span>
<div class="comments">
<div class="paragraph">
Start loop (once per direction+fire)
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ck_keyscan_loop</td>
<td class="address-2"><span id="f37f"></span>F37F</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Preserve the loop counter</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f380"></span>F380</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="4">Read screen address</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f381"></span>F381</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f382"></span>F382</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f383"></span>F383</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f384"></span>F384</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Preserve screen address</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f385"></span>F385</td>
<td class="instruction">LD ($F3E9),DE</td>
<td class="comment-1" rowspan="1">Self modify the "LD DE,$xxxx" at <a href="F350.html#f3e8">ck_plot_glyph</a> to load the screen address</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f389"></span>F389</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-1" rowspan="1">Set the debounce flag. This is only set to zero once we've checked the whole keyboard and no keys are pressed, at which point it gets set to zero</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f38b"></span>
<div class="comments">
<div class="paragraph">
Start loop (infinite)
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ck_keyscan_inner</td>
<td class="address-2"><span id="f38b"></span>F38B</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-1" rowspan="1">Bank the debounce flag</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f38c"></span>F38C</td>
<td class="instruction">LD HL,$F2E1</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at keyboard_port_hi_bytes[-1]</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f38f"></span>F38F</td>
<td class="instruction">LD D,$FF</td>
<td class="comment-1" rowspan="1">Initialise the port index</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f391"></span>
<div class="comments">
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ck_try_next_port</td>
<td class="address-2"><span id="f391"></span>F391</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to the next port high byte</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f392"></span>F392</td>
<td class="instruction">INC D</td>
<td class="comment-1" rowspan="1">Increment the port index</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f393"></span>F393</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Read the port high byte</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f394"></span>F394</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">Have we reached the end of keyboard_port_hi_bytes? ($00)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f395"></span>F395</td>
<td class="instruction">JR Z,<a href="F350.html#f38b">ck_keyscan_inner</a></td>
<td class="comment-1" rowspan="1">...loop if so (zero in <span class="register">A</span> becomes new debounce flag)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f397"></span>F397</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Read port high byte</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f398"></span>F398</td>
<td class="instruction">LD C,$FE</td>
<td class="comment-1" rowspan="1">Read port $FE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f39a"></span>F39A</td>
<td class="instruction">IN A,(C)</td>
<td class="comment-1" rowspan="1">Read the keyboard port</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f39c"></span>F39C</td>
<td class="instruction">CPL</td>
<td class="comment-1" rowspan="1">Invert the bits to turn active low into active high</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f39d"></span>F39D</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Copy the result into <span class="register">E</span> so we can restore it each time</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f39e"></span>F39E</td>
<td class="instruction">LD C,$20</td>
<td class="comment-1" rowspan="1">Create a mask with bit 5 set</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f3a0"></span>
<div class="comments">
<div class="paragraph">
Test bits 4,3,2,1,0
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ck_keyscan_detect</td>
<td class="address-2"><span id="f3a0"></span>F3A0</td>
<td class="instruction">SRL C</td>
<td class="comment-1" rowspan="1">Shift the mask right</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3a2"></span>F3A2</td>
<td class="instruction">JR C,<a href="F350.html#f391">ck_try_next_port</a></td>
<td class="comment-1" rowspan="1">Jump (to try next port) if the mask bit got shifted out</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3a4"></span>F3A4</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="2">Mask the result</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3a5"></span>F3A5</td>
<td class="instruction">AND E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3a6"></span>F3A6</td>
<td class="instruction">JR Z,<a href="F350.html#f3a0">ck_keyscan_detect</a></td>
<td class="comment-1" rowspan="1">...loop while no keys are pressed</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f3a8"></span>
<div class="comments">
<div class="paragraph">
We arrive here if a key was pressed.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3a8"></span>F3A8</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-1" rowspan="1">Unbank the debounce flag</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3a9"></span>F3A9</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">Is it set?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3aa"></span>F3AA</td>
<td class="instruction">JR NZ,<a href="F350.html#f38b">ck_keyscan_inner</a></td>
<td class="comment-1" rowspan="1">Restart the loop if so (<span class="register">A</span> is debounce flag)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3ac"></span>F3AC</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="2">Bank the port index</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3ad"></span>F3AD</td>
<td class="instruction">EX AF,AF'</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3ae"></span>F3AE</td>
<td class="instruction">LD HL,$F06A</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the byte before keydefs</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f3b1"></span>
<div class="comments">
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ck_next_keydef</td>
<td class="address-2"><span id="f3b1"></span>F3B1</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance to the next keydef</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3b2"></span>F3B2</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Read the keydef.port</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3b3"></span>F3B3</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">Is it an empty slot?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3b4"></span>F3B4</td>
<td class="instruction">JR Z,<a href="F350.html#f3c1">ck_assign_keydef</a></td>
<td class="comment-1" rowspan="1">Jump if so (assign keydef)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3b6"></span>F3B6</td>
<td class="instruction">CP B</td>
<td class="comment-1" rowspan="1">Does the port high byte match?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3b7"></span>F3B7</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> (interleaved)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3b8"></span>F3B8</td>
<td class="instruction">JR NZ,<a href="F350.html#f3b1">ck_next_keydef</a></td>
<td class="comment-1" rowspan="1">...loop if different</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3ba"></span>F3BA</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Read keydef.mask</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3bb"></span>F3BB</td>
<td class="instruction">CP C</td>
<td class="comment-1" rowspan="1">Does the mask match?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3bc"></span>F3BC</td>
<td class="instruction">JR NZ,<a href="F350.html#f3b1">ck_next_keydef</a></td>
<td class="comment-1" rowspan="1">...loop if different</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3be"></span>F3BE</td>
<td class="instruction">JP <a href="F350.html#f38b">ck_keyscan_inner</a></td>
<td class="comment-1" rowspan="1">...loop (infinite) (mask in <span class="register">A</span> becomes new debounce flag)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f3c1"></span>
<div class="comments">
<div class="paragraph">
Assign key definition.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ck_assign_keydef</td>
<td class="address-2"><span id="f3c1"></span>F3C1</td>
<td class="instruction">LD (HL),B</td>
<td class="comment-1" rowspan="2">Store port</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3c2"></span>F3C2</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3c3"></span>F3C3</td>
<td class="instruction">LD (HL),C</td>
<td class="comment-1" rowspan="1">Store mask</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3c4"></span>F3C4</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-1" rowspan="1">Unbank the port index</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3c5"></span>F3C5</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="4">Multiply it by 5</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3c6"></span>F3C6</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3c7"></span>F3C7</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3c8"></span>F3C8</td>
<td class="instruction">ADD A,B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3c9"></span>F3C9</td>
<td class="instruction">LD HL,$F302</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> one byte prior to <a href="F303.html">keycode_to_glyph</a>. This is off-by-one to compensate for the upcoming preincrement</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3cc"></span>F3CC</td>
<td class="instruction">ADD A,L</td>
<td class="comment-1" rowspan="4">Combine</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3cd"></span>F3CD</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3ce"></span>F3CE</td>
<td class="instruction">JR NC,<a href="F350.html#f3d1">ck_find_key_glyph</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3d0"></span>F3D0</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f3d1"></span>
<div class="comments">
<div class="paragraph">
Skip entries until the mask carries out.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ck_find_key_glyph</td>
<td class="address-2"><span id="f3d1"></span>F3D1</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance the glyph pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3d2"></span>F3D2</td>
<td class="instruction">RR C</td>
<td class="comment-1" rowspan="1">Shift mask</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3d4"></span>F3D4</td>
<td class="instruction">JR NC,<a href="F350.html#f3d1">ck_find_key_glyph</a></td>
<td class="comment-1" rowspan="1">...loop until the mask carries out</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3d6"></span>F3D6</td>
<td class="instruction">LD B,$01</td>
<td class="comment-1" rowspan="1">Set length to 1</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3d8"></span>F3D8</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Load the glyph</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3d9"></span>F3D9</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">Test the top bit</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3da"></span>F3DA</td>
<td class="instruction">JP P,<a href="F350.html#f3e8">ck_plot_glyph</a></td>
<td class="comment-1" rowspan="1">Jump if clear (JP P =&gt; positive)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f3dd"></span>
<div class="comments">
<div class="paragraph">
If the top bit was set then it's a special key, like SPACE or ENTER.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3dd"></span>F3DD</td>
<td class="instruction">AND $7F</td>
<td class="comment-1" rowspan="1">Extract the byte offset into special_key_names</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3df"></span>F3DF</td>
<td class="instruction">LD DE,$F2EB</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at special_key_names</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3e2"></span>F3E2</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="2">Widen byte offset into <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3e3"></span>F3E3</td>
<td class="instruction">LD H,$00</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3e5"></span>F3E5</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-1" rowspan="1">Combine</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3e6"></span>F3E6</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-1" rowspan="1">First byte is length of special key name</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3e7"></span>F3E7</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to point at glyphs</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f3e8"></span>
<div class="comments">
<div class="paragraph">
Plot.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ck_plot_glyph</td>
<td class="address-2"><span id="f3e8"></span>F3E8</td>
<td class="instruction">LD DE,$40D5</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at (a self modified screen address)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f3eb"></span>
<div class="comments">
<div class="paragraph">
Start loop (draw key)
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ck_plot_glyph_loop</td>
<td class="address-2"><span id="f3eb"></span>F3EB</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Preserve the loop counter</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f3ec"></span>
<div class="comments">
<div class="paragraph">
Bug: The next load is needless (plot_glyph does it already).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3ec"></span>F3EC</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Read a glyph</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3ed"></span>F3ED</td>
<td class="instruction">CALL <a href="7D2F.html">plot_glyph</a></td>
<td class="comment-1" rowspan="1">Plot a single glyph (indirectly)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3f0"></span>F3F0</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance to next glyph index</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3f1"></span>F3F1</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the loop counter</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3f2"></span>F3F2</td>
<td class="instruction">DJNZ <a href="F350.html#f3eb">ck_plot_glyph_loop</a></td>
<td class="comment-1" rowspan="1">...loop (draw key)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3f4"></span>F3F4</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore screen address</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3f5"></span>F3F5</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the loop counter</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3f6"></span>F3F6</td>
<td class="instruction">DEC B</td>
<td class="comment-1" rowspan="2">...loop (once per direction+fire)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3f7"></span>F3F7</td>
<td class="instruction">JR NZ,<a href="F350.html#f37f">ck_keyscan_loop</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f3f9"></span>
<div class="comments">
<div class="paragraph">
Delay loop.
</div>
<div class="paragraph">
This delays execution by approximately a third of a second (~1.25M T-states).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3f9"></span>F3F9</td>
<td class="instruction">LD BC,$FFFF</td>
<td class="comment-1" rowspan="1">Set <span class="register">BC</span> to $FFFF</td>
</tr>
<tr>
<td class="asm-label">ck_delay</td>
<td class="address-2"><span id="f3fc"></span>F3FC</td>
<td class="instruction">DEC BC</td>
<td class="comment-1" rowspan="4">Count down until it's zero</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3fd"></span>F3FD</td>
<td class="instruction">LD A,B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3fe"></span>F3FE</td>
<td class="instruction">OR C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f3ff"></span>F3FF</td>
<td class="instruction">JR NZ,<a href="F350.html#f3fc">ck_delay</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f401"></span>
<div class="comments">
<div class="paragraph">
Wait for the user's confirmation.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f401"></span>F401</td>
<td class="instruction">CALL <a href="EFFC.html">user_confirm</a></td>
<td class="comment-1" rowspan="1">Wait for the user to confirm by pressing 'Y' or 'N'</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f404"></span>F404</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">If Z set 'Y' was pressed so return</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="f405"></span>F405</td>
<td class="instruction">JP NZ,<a href="F350.html#f350">choose_keys</a></td>
<td class="comment-1" rowspan="1">...loop (infinite)</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="F335.html">F335</a>
</td>
<td class="up">Up: <a href="../maps/all.html#f350">Map</a></td>
<td class="next">
Next: <a href="F408.html">F408</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete The Great Escape disassembly 20240104</div>
<div class="copyright">&copy; 1986 Denton Designs &amp; Ocean Software Ltd. (The Great Escape). &copy; 2012-2024 David Thomas (this disassembly).</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.0.</div>
</footer>
</body>
</html>