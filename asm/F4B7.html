<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at F4B7</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="F446.html">F446</a></span></td>
<td class="up">Up: <a href="../maps/all.html#f4b7">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="F52C.html">F52C</a></span></td>
</tr>
</table>
<div class="description">F4B7: Runs the menu screen.</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="F163.html">F163</a>.
</div>
<div class="paragraph">
While waiting for user to select an input device this waves the morale flag and plays the title tune.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f4b7"></span>F4B7</td>
<td class="instruction">CALL <a href="F271.html">$F271</a></td>
<td class="comment-11" rowspan="1">for (;;) &lt;% check_menu_keys();</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4ba"></span>F4BA</td>
<td class="instruction">CALL <a href="A035.html">$A035</a></td>
<td class="comment-11" rowspan="1">wave_morale_flag();</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="f4bd"></span>
<div class="comments">
<div class="paragraph">
Play music.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4bd"></span>F4BD</td>
<td class="instruction">LD HL,($F541)</td>
<td class="comment-11" rowspan="2">HL = music_channel0_index + 1;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4c0"></span>F4C0</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="f4c1"></span>
<div class="comments">
<div class="paragraph">
Loop until the end marker is encountered.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f4c1"></span>F4C1</td>
<td class="instruction">LD ($F541),HL</td>
<td class="comment-11" rowspan="1">for (;;) &lt;% music_channel0_index = HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4c4"></span>F4C4</td>
<td class="instruction">LD DE,$F546</td>
<td class="comment-11" rowspan="3">A = music_channel0_data[HL];</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4c7"></span>F4C7</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4c8"></span>F4C8</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4c9"></span>F4C9</td>
<td class="instruction">CP $FF</td>
<td class="comment-11" rowspan="2">if (A != 0xFF) break; /* end marker */</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4cb"></span>F4CB</td>
<td class="instruction">JR NZ,$F4D2</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4cd"></span>F4CD</td>
<td class="instruction">LD HL,$0000</td>
<td class="comment-11" rowspan="1">HL = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4d0"></span>F4D0</td>
<td class="instruction">JR $F4C1</td>
<td class="comment-11" rowspan="1">%&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f4d2"></span>F4D2</td>
<td class="instruction">CALL <a href="F52C.html">$F52C</a></td>
<td class="comment-11" rowspan="1">get_tuning();</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4d5"></span>F4D5</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="f4d6"></span>
<div class="comments">
<div class="paragraph">
Loop until the end marker is encountered.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4d6"></span>F4D6</td>
<td class="instruction">LD HL,($F543)</td>
<td class="comment-11" rowspan="2">HLdash = music_channel1_index + 1;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4d9"></span>F4D9</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f4da"></span>F4DA</td>
<td class="instruction">LD ($F543),HL</td>
<td class="comment-11" rowspan="1">for (;;) &lt;% music_channel1_index = HLdash;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4dd"></span>F4DD</td>
<td class="instruction">LD DE,$F7C7</td>
<td class="comment-11" rowspan="3">A = music_channel1_data[HLdash];</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4e0"></span>F4E0</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4e1"></span>F4E1</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4e2"></span>F4E2</td>
<td class="instruction">CP $FF</td>
<td class="comment-11" rowspan="2">if (A != 0xFF) break; /* end marker */</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4e4"></span>F4E4</td>
<td class="instruction">JR NZ,$F4EB</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4e6"></span>F4E6</td>
<td class="instruction">LD HL,$0000</td>
<td class="comment-11" rowspan="1">HLdash = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4e9"></span>F4E9</td>
<td class="instruction">JR $F4DA</td>
<td class="comment-11" rowspan="1">%&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f4eb"></span>F4EB</td>
<td class="instruction">CALL <a href="F52C.html">$F52C</a></td>
<td class="comment-11" rowspan="1">get_tuning(); /* using banked registers */</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4ee"></span>F4EE</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1">A = Bdash;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4ef"></span>F4EF</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4f0"></span>F4F0</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4f1"></span>F4F1</td>
<td class="instruction">CP $FF</td>
<td class="comment-11" rowspan="2">if (A == 0xFF) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4f3"></span>F4F3</td>
<td class="instruction">JR NZ,$F4FC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4f5"></span>F4F5</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4f6"></span>F4F6</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">POP BCdash</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4f7"></span>F4F7</td>
<td class="instruction">LD E,C</td>
<td class="comment-11" rowspan="2">DEdash = BCdash;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4f8"></span>F4F8</td>
<td class="instruction">LD D,B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4f9"></span>F4F9</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">- %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4fa"></span>F4FA</td>
<td class="instruction">JR $F4FD</td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f4fc"></span>F4FC</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">%&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f4fd"></span>F4FD</td>
<td class="instruction">LD A,$18</td>
<td class="comment-11" rowspan="1">A = 24; /* overall tune speed (a delay: lower values are faster) */</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f4ff"></span>F4FF</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">do &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f500"></span>F500</td>
<td class="instruction">LD H,$FF</td>
<td class="comment-11" rowspan="1">H = 0xFF; /* iterations */</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f502"></span>F502</td>
<td class="instruction">DJNZ $F510</td>
<td class="comment-11" rowspan="1">do &lt;% if (--B == 0) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f504"></span>F504</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="2">if (--C == 0) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f505"></span>F505</td>
<td class="instruction">JP NZ,$F510</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f508"></span>F508</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="3">L ^= 16;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f509"></span>F509</td>
<td class="instruction">XOR $10</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f50b"></span>F50B</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f50c"></span>F50C</td>
<td class="instruction">OUT ($FE),A</td>
<td class="comment-11" rowspan="1">OUT ($FE),L</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f50e"></span>F50E</td>
<td class="instruction">LD C,E</td>
<td class="comment-11" rowspan="2">BC = DE; %&gt; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f50f"></span>F50F</td>
<td class="instruction">LD B,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f510"></span>F510</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f511"></span>F511</td>
<td class="instruction">DJNZ $F51F</td>
<td class="comment-11" rowspan="1">if (--Bdash == 0) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f513"></span>F513</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="2">if (--Cdash == 0) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f514"></span>F514</td>
<td class="instruction">JP NZ,$F51F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f517"></span>F517</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="3">Ldash ^= 16;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f518"></span>F518</td>
<td class="instruction">XOR $10</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f51a"></span>F51A</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f51b"></span>F51B</td>
<td class="instruction">OUT ($FE),A</td>
<td class="comment-11" rowspan="1">OUT ($FE),Ldash</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f51d"></span>F51D</td>
<td class="instruction">LD C,E</td>
<td class="comment-11" rowspan="2">BCdash = DEdash; %&gt; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f51e"></span>F51E</td>
<td class="instruction">LD B,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f51f"></span>F51F</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f520"></span>F520</td>
<td class="instruction">DEC H</td>
<td class="comment-11" rowspan="2">%&gt; while (--H);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f521"></span>F521</td>
<td class="instruction">JP NZ,$F502</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f524"></span>F524</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f525"></span>F525</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="2">%&gt; while (--A);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f526"></span>F526</td>
<td class="instruction">JP NZ,$F4FF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f529"></span>F529</td>
<td class="instruction">JP $F4B7</td>
<td class="comment-11" rowspan="1">%&gt;</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="F446.html">F446</a></span></td>
<td class="up">Up: <a href="../maps/all.html#f4b7">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="F52C.html">F52C</a></span></td>
</tr>
</table>
<footer>
<div class="release">The incomplete The Great Escape disassembly 20160326</div>
<div class="copyright">&copy; Denton Designs. Ocean. David Thomas.</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 5.1.</div>
</footer>
</body>
</html>