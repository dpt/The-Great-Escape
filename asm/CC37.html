<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at CC37</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="The Great Escape" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="CC31.html">CC31</a>
</td>
<td class="up">Up: <a href="../maps/all.html#cc37">Map</a></td>
<td class="next">
Next: <a href="CCAB.html">CCAB</a>
</td>
</tr>
</table>
<div class="description">CC37: Guards follow suspicious character</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
This routine decides whether the given vischar should pursue the hero.
</div>
<div class="paragraph">
The commandant can see through the hero's disguise if he's wearing the guard's uniform, but other guards do not. Bribed characters will ignore the hero. When outdoors, line of sight checking is used to determine if the hero will be pursued. If the <a href="A138.html">red_flag</a> is in effect the hero will be pursued, otherwise he will just be hassled.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">Used</td>
<td class="register-desc">by the routine at <a href="C892.html">automatics</a>.</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="cc37"></span>
<div class="comments">
<div class="paragraph">
I:IY Pointer to visible character.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">guards_follow_suspicious_character</td>
<td class="address-2"><span id="cc37"></span>CC37</td>
<td class="instruction">PUSH IY</td>
<td class="comment-1" rowspan="2">Copy vischar pointer into <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc39"></span>CC39</td>
<td class="instruction">POP HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc3a"></span>CC3A</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch the character index</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="cc3b"></span>
<div class="comments">
<div class="paragraph">
Wearing the uniform stops anyone but the commandant from pursuing the hero.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc3b"></span>CC3B</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is it character_0_COMMANDANT?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc3c"></span>CC3C</td>
<td class="instruction">JR Z,<a href="CC37.html#cc46">gfsc_chk_bribe</a></td>
<td class="comment-1" rowspan="1">Jump if so (the commandant sees through the disguise)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc3e"></span>CC3E</td>
<td class="instruction">LD A,($8015)</td>
<td class="comment-1" rowspan="1">Read the bottom byte of the hero's sprite set pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc41"></span>CC41</td>
<td class="instruction">LD DE,$CEA6</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the guard sprite set</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc44"></span>CC44</td>
<td class="instruction">CP E</td>
<td class="comment-1" rowspan="2">Return if they match</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc45"></span>CC45</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="cc46"></span>
<div class="comments">
<div class="paragraph">
If this (hostile) character saw the bribe being used then ignore the hero.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">gfsc_chk_bribe</td>
<td class="address-2"><span id="cc46"></span>CC46</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to point at vischar.flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc47"></span>CC47</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch vischar.flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc48"></span>CC48</td>
<td class="instruction">CP $04</td>
<td class="comment-1" rowspan="1">Is it vischar_PURSUIT_SAW_BRIBE?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc4a"></span>CC4A</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">Return if the bribe was seen</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="cc4b"></span>
<div class="comments">
<div class="paragraph">
Do line of sight checking when outdoors.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc4b"></span>CC4B</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="1">Rewind <span class="register">HL</span> to point at vischar.character</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc4c"></span>CC4C</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> at vischar.mi.pos</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc4d"></span>CC4D</td>
<td class="instruction">ADD A,$0F</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc4f"></span>CC4F</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc50"></span>CC50</td>
<td class="instruction">LD DE,$81B2</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at tinypos_stash_x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc53"></span>CC53</td>
<td class="instruction">LD A,($68A0)</td>
<td class="comment-1" rowspan="3">If the global current room index is room_0_OUTDOORS...</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc56"></span>CC56</td>
<td class="instruction">AND A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc57"></span>CC57</td>
<td class="instruction">JP NZ,<a href="CC37.html#cc92">gfsc_chk_flag</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc5a"></span>CC5A</td>
<td class="instruction">CALL <a href="E542.html">pos_to_tinypos</a></td>
<td class="comment-1" rowspan="1">Scale down vischar's map position (<span class="register">HL</span>) and assign the result to tinypos_stash (<span class="register">DE</span>). <span class="register">DE</span> is updated to point after tinypos_stash on return</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc5d"></span>CC5D</td>
<td class="instruction">LD HL,$81B8</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at hero_map_position.x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc60"></span>CC60</td>
<td class="instruction">LD DE,$81B2</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at tinypos_stash_x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc63"></span>CC63</td>
<td class="instruction">LD A,(IY+$0E)</td>
<td class="comment-1" rowspan="1">Get this vischar's direction</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="cc66"></span>
<div class="comments">
<div class="paragraph">
Check for TL/BR directions.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc66"></span>CC66</td>
<td class="instruction">RRA</td>
<td class="comment-1" rowspan="1">Shift out the bottom direction bit into carry</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc67"></span>CC67</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Save (rotated direction byte) in <span class="register">C</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc68"></span>CC68</td>
<td class="instruction">JR C,<a href="CC37.html#cc80">gfsc_chk_seen_x</a></td>
<td class="comment-1" rowspan="1">Jump if not TL or BR</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="cc6a"></span>
<div class="comments">
<div class="paragraph">
Handle TL/BR directions.
</div>
<div class="paragraph">
Does the hero approximately match our Y coordinate?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">gfsc_chk_seen_y</td>
<td class="address-1"><span id="cc6a"></span>CC6A</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to hero_map_position.y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc6b"></span>CC6B</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Advance <span class="register">DE</span> to tinypos_stash_y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc6c"></span>CC6C</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Fetch tinypos_stash_y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc6d"></span>CC6D</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="3">Return if (tinypos_stash_y - 1) &gt;= hero_map_position.y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc6e"></span>CC6E</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc6f"></span>CC6F</td>
<td class="instruction">RET NC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc70"></span>CC70</td>
<td class="instruction">ADD A,$02</td>
<td class="comment-1" rowspan="3">Return if (tinypos_stash_y + 1) &lt; hero_map_position.y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc72"></span>CC72</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc73"></span>CC73</td>
<td class="instruction">RET C</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="cc74"></span>
<div class="comments">
<div class="paragraph">
Are we facing the hero?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc74"></span>CC74</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Rewind to hero_map_position_x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc75"></span>CC75</td>
<td class="instruction">DEC DE</td>
<td class="comment-1" rowspan="1">Rewind to tinypos_stash_x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc76"></span>CC76</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="2">Set carry if tinypos_stash_x &lt; hero_map_position_x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc77"></span>CC77</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc78"></span>CC78</td>
<td class="instruction">BIT 0,C</td>
<td class="comment-1" rowspan="1">Check bit 1 of direction byte (direction_BOTTOM_*?)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc7a"></span>CC7A</td>
<td class="instruction">JR NZ,<a href="CC37.html#cc7d">guards_follow_suspicious_character_0</a></td>
<td class="comment-1" rowspan="1">Jump if set?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc7c"></span>CC7C</td>
<td class="instruction">CCF</td>
<td class="comment-1" rowspan="1">Otherwise invert the carry flag</td>
</tr>
<tr>
<td class="asm-label">guards_follow_suspicious_character_0</td>
<td class="address-2"><span id="cc7d"></span>CC7D</td>
<td class="instruction">RET C</td>
<td class="comment-1" rowspan="1">Return if set</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc7e"></span>CC7E</td>
<td class="instruction">JR <a href="CC37.html#cc92">gfsc_chk_flag</a></td>
<td class="comment-1" rowspan="1">(else)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="cc80"></span>
<div class="comments">
<div class="paragraph">
Handle TR/BL directions.
</div>
<div class="paragraph">
Does the hero approximately match our X coordinate?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">gfsc_chk_seen_x</td>
<td class="address-2"><span id="cc80"></span>CC80</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Fetch tinypos_stash_x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc81"></span>CC81</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="3">Return if (tinypos_stash_x - 1) &gt;= hero_map_position_x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc82"></span>CC82</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc83"></span>CC83</td>
<td class="instruction">RET NC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc84"></span>CC84</td>
<td class="instruction">ADD A,$02</td>
<td class="comment-1" rowspan="3">Return if (tinypos_stash_x + 1) &lt; hero_map_position_x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc86"></span>CC86</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc87"></span>CC87</td>
<td class="instruction">RET C</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="cc88"></span>
<div class="comments">
<div class="paragraph">
Are we facing the hero?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc88"></span>CC88</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance to hero_map_position_y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc89"></span>CC89</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Advance to tinypos_stash_y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc8a"></span>CC8A</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="2">Set carry if tinypos_stash_y &lt; hero_map_position_y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc8b"></span>CC8B</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc8c"></span>CC8C</td>
<td class="instruction">BIT 0,C</td>
<td class="comment-1" rowspan="1">Check bit 1 of direction byte (direction_BOTTOM_*?)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc8e"></span>CC8E</td>
<td class="instruction">JR NZ,<a href="CC37.html#cc91">guards_follow_suspicious_character_1</a></td>
<td class="comment-1" rowspan="1">Jump if set?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc90"></span>CC90</td>
<td class="instruction">CCF</td>
<td class="comment-1" rowspan="1">Otherwise invert the carry flag</td>
</tr>
<tr>
<td class="asm-label">guards_follow_suspicious_character_1</td>
<td class="address-2"><span id="cc91"></span>CC91</td>
<td class="instruction">RET C</td>
<td class="comment-1" rowspan="1">Return if set</td>
</tr>
<tr>
<td class="asm-label">gfsc_chk_flag</td>
<td class="address-2"><span id="cc92"></span>CC92</td>
<td class="instruction">LD A,($A138)</td>
<td class="comment-1" rowspan="2">Is red_flag set?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc95"></span>CC95</td>
<td class="instruction">AND A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc96"></span>CC96</td>
<td class="instruction">JR NZ,<a href="CC37.html#cca3">gfsc_bell</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="cc98"></span>
<div class="comments">
<div class="paragraph">
Hostiles *not* in guard towers hassle the hero.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc98"></span>CC98</td>
<td class="instruction">LD A,(IY+$13)</td>
<td class="comment-1" rowspan="1">Fetch vischar.mi.pos.height</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc9b"></span>CC9B</td>
<td class="instruction">CP $20</td>
<td class="comment-1" rowspan="2">Return if it's 32 or greater</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc9d"></span>CC9D</td>
<td class="instruction">RET NC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cc9e"></span>CC9E</td>
<td class="instruction">LD (IY+$01),$02</td>
<td class="comment-1" rowspan="1">Set vischar's flags to vischar_PURSUIT_HASSLE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cca2"></span>CCA2</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
<tr>
<td class="asm-label">gfsc_bell</td>
<td class="address-2"><span id="cca3"></span>CCA3</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Make the bell ring perpetually</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cca4"></span>CCA4</td>
<td class="instruction">LD ($A130),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="cca7"></span>CCA7</td>
<td class="instruction">CALL <a href="CCAB.html">hostiles_pursue</a></td>
<td class="comment-1" rowspan="1">Call hostiles_pursue</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="ccaa"></span>CCAA</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="CC31.html">CC31</a>
</td>
<td class="up">Up: <a href="../maps/all.html#cc37">Map</a></td>
<td class="next">
Next: <a href="CCAB.html">CCAB</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete The Great Escape disassembly 20240104</div>
<div class="copyright">&copy; 1986 Denton Designs &amp; Ocean Software Ltd. (The Great Escape). &copy; 2012-2024 David Thomas (this disassembly).</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.0.</div>
</footer>
</body>
</html>