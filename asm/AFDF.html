<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at AFDF</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="The Great Escape" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="AF8F.html">AF8F</a>
</td>
<td class="up">Up: <a href="../maps/all.html#afdf">Map</a></td>
<td class="next">
Next: <a href="B107.html">B107</a>
</td>
</tr>
</table>
<div class="description">AFDF: Collision</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
This handles collisions, including items being pushed around.
</div>
<div class="paragraph">
Used by the routines at <a href="AF8F.html">touch</a> and <a href="C4E0.html">spawn_character</a>.
</div>
</div>
<table class="output">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>
<tr>
<td class="register">F</td>
<td class="register-desc">Z/NZ =&gt; no collision/collision.</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="afdf"></span>
<div class="comments">
<div class="paragraph">
Iterate over characters being collided with (e.g. stove).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">collision</td>
<td class="address-2"><span id="afdf"></span>AFDF</td>
<td class="instruction">LD HL,$8001</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the first vischar's flags field</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="afe2"></span>AFE2</td>
<td class="instruction">LD B,$08</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> for eight iterations</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="afe4"></span>
<div class="comments">
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">collision_0</td>
<td class="address-2"><span id="afe4"></span>AFE4</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">Is the vischar_FLAGS_NO_COLLIDE flag bit set?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="afe6"></span>AFE6</td>
<td class="instruction">JP NZ,<a href="AFDF.html#b0fe">collision_18</a></td>
<td class="comment-1" rowspan="1">Skip if so</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="afe9"></span>AFE9</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Preserve the loop counter</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="afea"></span>AFEA</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Preserve the vischar pointer</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="afeb"></span>
<div class="comments">
<div class="paragraph">
Test for contact between the current vischar and saved_pos.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="afeb"></span>AFEB</td>
<td class="instruction">LD A,$0E</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> at vischar's X position</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="afed"></span>AFED</td>
<td class="instruction">ADD A,L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="afee"></span>AFEE</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="afef"></span>
<div class="comments">
<div class="paragraph">
Check X is within (-4..+4)
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="afef"></span>AFEF</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="3">Fetch X position</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="aff0"></span>AFF0</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="aff1"></span>AFF1</td>
<td class="instruction">LD B,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="aff2"></span>AFF2</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Save our vischar pointer while we compare bounds</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="aff3"></span>AFF3</td>
<td class="instruction">LD HL,($81A4)</td>
<td class="comment-1" rowspan="1">Fetch saved_pos_x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="aff6"></span>AFF6</td>
<td class="instruction">LD A,$04</td>
<td class="comment-1" rowspan="5">Add 4 to the X position - our upper bound</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="aff8"></span>AFF8</td>
<td class="instruction">ADD A,C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="aff9"></span>AFF9</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="affa"></span>AFFA</td>
<td class="instruction">JR NC,<a href="AFDF.html#affe">collision_1</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="affc"></span>AFFC</td>
<td class="instruction">INC B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="affd"></span>AFFD</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Clear the carry flag</td>
</tr>
<tr>
<td class="asm-label">collision_1</td>
<td class="address-2"><span id="affe"></span>AFFE</td>
<td class="instruction">SBC HL,BC</td>
<td class="comment-1" rowspan="1">Compare saved_pos_x to (X position + 4)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b000"></span>B000</td>
<td class="instruction">JR Z,<a href="AFDF.html#b014">collision_3</a></td>
<td class="comment-1" rowspan="1">Equal - jump forward to comparing Y position</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b002"></span>B002</td>
<td class="instruction">JP NC,<a href="AFDF.html#b0fc">collision_pop_next</a></td>
<td class="comment-1" rowspan="1">If (saved_pos_x &gt;= (X position + 4)) there was no collision, so jump to the next iteration</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b005"></span>B005</td>
<td class="instruction">SUB $08</td>
<td class="comment-1" rowspan="5">Reduce <span class="register">A</span> by 8 giving (X position - 4) - our lower bound</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b007"></span>B007</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b008"></span>B008</td>
<td class="instruction">JR NC,<a href="AFDF.html#b00c">collision_2</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b00a"></span>B00A</td>
<td class="instruction">DEC B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b00b"></span>B00B</td>
<td class="instruction">AND A</td>
</tr>
<tr>
<td class="asm-label">collision_2</td>
<td class="address-2"><span id="b00c"></span>B00C</td>
<td class="instruction">LD HL,($81A4)</td>
<td class="comment-1" rowspan="1">Fetch saved_pos_x again</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b00f"></span>B00F</td>
<td class="instruction">SBC HL,BC</td>
<td class="comment-1" rowspan="1">Compare saved_pos_x to (X position - 4)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b011"></span>B011</td>
<td class="instruction">JP C,<a href="AFDF.html#b0fc">collision_pop_next</a></td>
<td class="comment-1" rowspan="1">If (saved_pos_x &lt; (X position - 4)) there was no collision, so jump to the next iteration</td>
</tr>
<tr>
<td class="asm-label">collision_3</td>
<td class="address-2"><span id="b014"></span>B014</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Restore our vischar pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b015"></span>B015</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Advance to Y position</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b016"></span>
<div class="comments">
<div class="paragraph">
Check Y is within (-4..+4)
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b016"></span>B016</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="3">Fetch Y position</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b017"></span>B017</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b018"></span>B018</td>
<td class="instruction">LD B,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b019"></span>B019</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Save our vischar pointer while we compare bounds</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b01a"></span>B01A</td>
<td class="instruction">LD HL,($81A6)</td>
<td class="comment-1" rowspan="1">Fetch saved_pos_y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b01d"></span>B01D</td>
<td class="instruction">LD A,$04</td>
<td class="comment-1" rowspan="5">Add 4 to the Y position - our upper bound</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b01f"></span>B01F</td>
<td class="instruction">ADD A,C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b020"></span>B020</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b021"></span>B021</td>
<td class="instruction">JR NC,<a href="AFDF.html#b025">collision_4</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b023"></span>B023</td>
<td class="instruction">INC B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b024"></span>B024</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Clear the carry flag</td>
</tr>
<tr>
<td class="asm-label">collision_4</td>
<td class="address-2"><span id="b025"></span>B025</td>
<td class="instruction">SBC HL,BC</td>
<td class="comment-1" rowspan="1">Compare saved_pos_y to (Y position + 4)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b027"></span>B027</td>
<td class="instruction">JR Z,<a href="AFDF.html#b03b">collision_6</a></td>
<td class="comment-1" rowspan="1">Equal - jump forward to comparing height</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b029"></span>B029</td>
<td class="instruction">JP NC,<a href="AFDF.html#b0fc">collision_pop_next</a></td>
<td class="comment-1" rowspan="1">If (saved_pos_y &gt;= (Y position + 4)) there was no collision, so jump to the next iteration</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b02c"></span>B02C</td>
<td class="instruction">SUB $08</td>
<td class="comment-1" rowspan="5">Reduce <span class="register">A</span> by 8 giving (Y position - 4) - our lower bound</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b02e"></span>B02E</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b02f"></span>B02F</td>
<td class="instruction">JR NC,<a href="AFDF.html#b033">collision_5</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b031"></span>B031</td>
<td class="instruction">DEC B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b032"></span>B032</td>
<td class="instruction">AND A</td>
</tr>
<tr>
<td class="asm-label">collision_5</td>
<td class="address-2"><span id="b033"></span>B033</td>
<td class="instruction">LD HL,($81A6)</td>
<td class="comment-1" rowspan="1">Fetch saved_pos_y again</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b036"></span>B036</td>
<td class="instruction">SBC HL,BC</td>
<td class="comment-1" rowspan="1">Compare saved_pos_y to (Y position - 4)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b038"></span>B038</td>
<td class="instruction">JP C,<a href="AFDF.html#b0fc">collision_pop_next</a></td>
<td class="comment-1" rowspan="1">If (saved_pos_y &lt; (Y position - 4)) there was no collision, so jump to the next iteration</td>
</tr>
<tr>
<td class="asm-label">collision_6</td>
<td class="address-2"><span id="b03b"></span>B03B</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Restore our vischar pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b03c"></span>B03C</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Advance to height</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b03d"></span>
<div class="comments">
<div class="paragraph">
Ensure that the heights are within 24 of each other. This will stop the character colliding with any guards high up in watchtowers.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b03d"></span>B03D</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="1">Fetch height</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b03e"></span>B03E</td>
<td class="instruction">LD A,($81A8)</td>
<td class="comment-1" rowspan="1">Fetch saved_height</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b041"></span>B041</td>
<td class="instruction">SUB C</td>
<td class="comment-1" rowspan="1">Subtract height from saved_height</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b042"></span>B042</td>
<td class="instruction">JR NC,<a href="AFDF.html#b046">collision_7</a></td>
<td class="comment-1" rowspan="2">If negative flip the sign - get the absolute value</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b044"></span>B044</td>
<td class="instruction">NEG</td>
</tr>
<tr>
<td class="asm-label">collision_7</td>
<td class="address-2"><span id="b046"></span>B046</td>
<td class="instruction">CP $18</td>
<td class="comment-1" rowspan="2">If the result is &gt;= 24 then jump to the next iteration</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b048"></span>B048</td>
<td class="instruction">JP NC,<a href="AFDF.html#b0fc">collision_pop_next</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b04b"></span>
<div class="comments">
<div class="paragraph">
Check for pursuit.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b04b"></span>B04B</td>
<td class="instruction">LD A,(IY+$01)</td>
<td class="comment-1" rowspan="1">Read the vischar's flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b04e"></span>B04E</td>
<td class="instruction">AND $0F</td>
<td class="comment-1" rowspan="1">AND the flags with vischar_FLAGS_PURSUIT_MASK</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b050"></span>B050</td>
<td class="instruction">CP $01</td>
<td class="comment-1" rowspan="1">Is the result vischar_PURSUIT_PURSUE?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b052"></span>B052</td>
<td class="instruction">JR NZ,<a href="AFDF.html#b071">collision_9</a></td>
<td class="comment-1" rowspan="1">If not, jump forward to collision checking</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b054"></span>
<div class="comments">
<div class="paragraph">
Vischar (IY) is pursuing.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b054"></span>B054</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="2">Restore vischar pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b055"></span>B055</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b056"></span>B056</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="1">Point at vischar base, not flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b057"></span>B057</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="3">Is the current vischar the hero's? ($8000)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b058"></span>B058</td>
<td class="instruction">AND A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b059"></span>B059</td>
<td class="instruction">JR NZ,<a href="AFDF.html#b071">collision_9</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b05b"></span>
<div class="comments">
<div class="paragraph">
Currently tested vischar (HL) is the hero's.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b05b"></span>B05B</td>
<td class="instruction">LD A,($AF8E)</td>
<td class="comment-1" rowspan="1">Fetch global bribed character</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b05e"></span>B05E</td>
<td class="instruction">CP (IY+$00)</td>
<td class="comment-1" rowspan="1">Does it match IY's vischar character?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b061"></span>B061</td>
<td class="instruction">JR NZ,<a href="AFDF.html#b068">collision_8</a></td>
<td class="comment-1" rowspan="1">No, jump forward to solitary check</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b063"></span>
<div class="comments">
<div class="paragraph">
Vischar <span class="register">IY</span> is a bribed character pursuing the hero.
</div>
<div class="paragraph">
When the pursuer catches the hero the bribe will be accepted.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b063"></span>B063</td>
<td class="instruction">CALL <a href="B107.html">accept_bribe</a></td>
<td class="comment-1" rowspan="1">Call accept_bribe</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b066"></span>B066</td>
<td class="instruction">JR <a href="AFDF.html#b071">collision_9</a></td>
<td class="comment-1" rowspan="1">(else)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b068"></span>
<div class="comments">
<div class="paragraph">
Vischar <span class="register">IY</span> is a hostile who's caught the hero!
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">collision_8</td>
<td class="address-2"><span id="b068"></span>B068</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore vischar pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b069"></span>B069</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore loop counter</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b06a"></span>B06A</td>
<td class="instruction">PUSH IY</td>
<td class="comment-1" rowspan="3">Unused sequence: <span class="register">HL</span> = <span class="register">IY</span> + 1</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b06c"></span>B06C</td>
<td class="instruction">POP HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b06d"></span>B06D</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b06e"></span>B06E</td>
<td class="instruction">JP <a href="CB98.html">solitary</a></td>
<td class="comment-1" rowspan="1">Exit via solitary</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b071"></span>
<div class="comments">
<div class="paragraph">
Check for collisions with items.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">collision_9</td>
<td class="address-2"><span id="b071"></span>B071</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore vischar pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b072"></span>B072</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="1">Point at vischar base, not flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b073"></span>B073</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch the vischar's character</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b074"></span>B074</td>
<td class="instruction">CP $1A</td>
<td class="comment-1" rowspan="1">Is the character &gt;= character_26_STOVE_1?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b076"></span>B076</td>
<td class="instruction">JR C,<a href="AFDF.html#b0b9">collision_16</a></td>
<td class="comment-1" rowspan="1">Jump if NOT</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b078"></span>
<div class="comments">
<div class="paragraph">
It's an item.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b078"></span>B078</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Preserve the vischar pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b079"></span>B079</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-1" rowspan="1">Bank the character index</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b07a"></span>B07A</td>
<td class="instruction">LD A,$11</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> at vischar-&gt;mi.pos.y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b07c"></span>B07C</td>
<td class="instruction">ADD A,L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b07d"></span>B07D</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b07e"></span>B07E</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-1" rowspan="1">Retrieve the character index</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b07f"></span>
<div class="comments">
<div class="paragraph">
By default, setup for the stove. It can move on the Y axis only (bottom left to top right).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b07f"></span>B07F</td>
<td class="instruction">LD BC,$0723</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> to 7 - the permitted range, in either direction, from the centre point and set <span class="register">C</span> to 35 - the centre point</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b082"></span>B082</td>
<td class="instruction">CP $1C</td>
<td class="comment-1" rowspan="1">Compare character index with character_28_CRATE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b084"></span>B084</td>
<td class="instruction">LD A,(IY+$0E)</td>
<td class="comment-1" rowspan="1">(interleaved) Fetch IY's direction</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b087"></span>B087</td>
<td class="instruction">JR NZ,<a href="AFDF.html#b08f">collision_10</a></td>
<td class="comment-1" rowspan="1">If it's not the crate then jump to the stove handling</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b089"></span>
<div class="comments">
<div class="paragraph">
Handle the crate. It can move on the X axis only (top left to bottom right).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b089"></span>B089</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at vischar-&gt;mi.pos.x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b08a"></span>B08A</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b08b"></span>B08B</td>
<td class="instruction">LD C,$36</td>
<td class="comment-1" rowspan="1">Centre point is 54 (crate will move 47..54..61)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b08d"></span>B08D</td>
<td class="instruction">XOR $01</td>
<td class="comment-1" rowspan="1">Swap axis left&lt;=&gt;right</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b08f"></span>
<div class="comments">
<div class="paragraph">
Top left case.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">collision_10</td>
<td class="address-2"><span id="b08f"></span>B08F</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Test the direction: Is it top left? (zero)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b090"></span>B090</td>
<td class="instruction">JR NZ,<a href="AFDF.html#b09d">collision_12</a></td>
<td class="comment-1" rowspan="1">Jump forward to next check if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b092"></span>
<div class="comments">
<div class="paragraph">
The player is pushing the movable item from its front, so centre it.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b092"></span>B092</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Load the coordinate</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b093"></span>B093</td>
<td class="instruction">CP C</td>
<td class="comment-1" rowspan="1">Is it already at the centre point?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b094"></span>B094</td>
<td class="instruction">JR Z,<a href="AFDF.html#b0b8">collision_15</a></td>
<td class="comment-1" rowspan="1">Jump forward if so</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b096"></span>B096</td>
<td class="instruction">JR C,<a href="AFDF.html#b09a">collision_11</a></td>
<td class="comment-1" rowspan="4">If the coordinate is larger than the centre point then decrement, else increment its position</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b098"></span>B098</td>
<td class="instruction">DEC (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b099"></span>B099</td>
<td class="instruction">DEC (HL)</td>
</tr>
<tr>
<td class="asm-label">collision_11</td>
<td class="address-2"><span id="b09a"></span>B09A</td>
<td class="instruction">INC (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b09b"></span>B09B</td>
<td class="instruction">JR <a href="AFDF.html#b0b8">collision_15</a></td>
<td class="comment-1" rowspan="1">(else)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b09d"></span>
<div class="comments">
<div class="paragraph">
Top right case.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">collision_12</td>
<td class="address-2"><span id="b09d"></span>B09D</td>
<td class="instruction">CP $01</td>
<td class="comment-1" rowspan="1">Test the direction: Is it top right? (one)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b09f"></span>B09F</td>
<td class="instruction">JR NZ,<a href="AFDF.html#b0a9">collision_13</a></td>
<td class="comment-1" rowspan="1">Jump forward to next check if not</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0a1"></span>B0A1</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="5">If the coordinate is not at its maximum (C+B) then increment its position</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0a2"></span>B0A2</td>
<td class="instruction">ADD A,B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0a3"></span>B0A3</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0a4"></span>B0A4</td>
<td class="instruction">JR Z,<a href="AFDF.html#b0b8">collision_15</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0a6"></span>B0A6</td>
<td class="instruction">INC (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0a7"></span>B0A7</td>
<td class="instruction">JR <a href="AFDF.html#b0b8">collision_15</a></td>
<td class="comment-1" rowspan="1">(else)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b0a9"></span>
<div class="comments">
<div class="paragraph">
Bottom right case.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">collision_13</td>
<td class="address-2"><span id="b0a9"></span>B0A9</td>
<td class="instruction">CP $02</td>
<td class="comment-1" rowspan="1">Test the direction: Is it bottom right? (two)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0ab"></span>B0AB</td>
<td class="instruction">JR NZ,<a href="AFDF.html#b0b2">collision_14</a></td>
<td class="comment-1" rowspan="1">Jump forward to next check if not</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0ad"></span>B0AD</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="3">Set the position to minimum (C-B) irrespective. Note that this never seems to happen in practice in the game</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0ae"></span>B0AE</td>
<td class="instruction">SUB B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0af"></span>B0AF</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0b0"></span>B0B0</td>
<td class="instruction">JR <a href="AFDF.html#b0b8">collision_15</a></td>
<td class="comment-1" rowspan="1">(else)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b0b2"></span>
<div class="comments">
<div class="paragraph">
Bottom left case.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">collision_14</td>
<td class="address-2"><span id="b0b2"></span>B0B2</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="5">If the coordinate is not at its minimum (C-B) then decrement its position</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0b3"></span>B0B3</td>
<td class="instruction">SUB B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0b4"></span>B0B4</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0b5"></span>B0B5</td>
<td class="instruction">JR Z,<a href="AFDF.html#b0b8">collision_15</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0b7"></span>B0B7</td>
<td class="instruction">DEC (HL)</td>
</tr>
<tr>
<td class="asm-label">collision_15</td>
<td class="address-2"><span id="b0b8"></span>B0B8</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the vischar pointer</td>
</tr>
<tr>
<td class="asm-label">collision_16</td>
<td class="address-2"><span id="b0b9"></span>B0B9</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the loop counter</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b0ba"></span>
<div class="comments">
<div class="paragraph">
Check for collisions with characters.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0ba"></span>B0BA</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="3">Point at vischar input field</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0bb"></span>B0BB</td>
<td class="instruction">ADD A,$0D</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0bd"></span>B0BD</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0be"></span>B0BE</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="2">Load the input field and mask off the input_KICK flag</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0bf"></span>B0BF</td>
<td class="instruction">AND $7F</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0c1"></span>B0C1</td>
<td class="instruction">JR Z,<a href="AFDF.html#b0db">collided_facing</a></td>
<td class="comment-1" rowspan="1">Jump forward if the input field is zero</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0c3"></span>B0C3</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Point at the direction field</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0c4"></span>B0C4</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="2">Swap direction top &lt;=&gt; bottom</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0c5"></span>B0C5</td>
<td class="instruction">XOR $02</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0c7"></span>B0C7</td>
<td class="instruction">CP (IY+$0E)</td>
<td class="comment-1" rowspan="2">If direction != state-&gt;IY-&gt;direction</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0ca"></span>B0CA</td>
<td class="instruction">JR Z,<a href="AFDF.html#b0db">collided_facing</a></td>
</tr>
<tr>
<td class="asm-label">collided_not_facing</td>
<td class="address-1"><span id="b0cc"></span>B0CC</td>
<td class="instruction">LD (IY+$0D),$80</td>
<td class="comment-1" rowspan="1">Set IY's input to input_KICK</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b0d0"></span>
<div class="comments">
<div class="paragraph">
Delay calling character_behaviour for five turns. This delay controls how long it takes before a blocked character will try another direction.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">collided_set_delay</td>
<td class="address-2"><span id="b0d0"></span>B0D0</td>
<td class="instruction">LD A,(IY+$07)</td>
<td class="comment-1" rowspan="4">IY-&gt;counter_and_flags = (IY-&gt;counter_and_flags &amp; ~vischar_BYTE7_COUNTER_MASK) | 5</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0d3"></span>B0D3</td>
<td class="instruction">AND $F0</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0d5"></span>B0D5</td>
<td class="instruction">OR $05</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0d7"></span>B0D7</td>
<td class="instruction">LD (IY+$07),A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b0da"></span>
<div class="comments">
<div class="paragraph">
Note: The following return does work but it's odd that it's conditional.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0da"></span>B0DA</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b0db"></span>
<div class="comments">
<div class="paragraph">
Note: The <span class="register">C</span> direction field ought to be masked so that we don't access out-of-bounds in new_inputs[] if we collide when crawling.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">collided_facing</td>
<td class="address-2"><span id="b0db"></span>B0DB</td>
<td class="instruction">LD C,(IY+$0E)</td>
<td class="comment-1" rowspan="2">Fetch IY-&gt;direction, widening it to BC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0de"></span>B0DE</td>
<td class="instruction">LD B,$00</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0e0"></span>B0E0</td>
<td class="instruction">LD HL,$B0F8</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at collision_new_inputs</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0e3"></span>B0E3</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1">Index it by direction (in BC)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0e4"></span>B0E4</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch the direction</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0e5"></span>B0E5</td>
<td class="instruction">LD (IY+$0D),A</td>
<td class="comment-1" rowspan="1">IY-&gt;input = direction</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0e8"></span>B0E8</td>
<td class="instruction">BIT 0,C</td>
<td class="comment-1" rowspan="1">Is the new direction TR or BL?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0ea"></span>B0EA</td>
<td class="instruction">JR NZ,<a href="AFDF.html#b0f2">collision_17</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0ec"></span>B0EC</td>
<td class="instruction">RES 5,(IY+$07)</td>
<td class="comment-1" rowspan="1">IY-&gt;counter_and_flags &amp;= ~vischar_BYTE7_Y_DOMINANT</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0f0"></span>B0F0</td>
<td class="instruction">JR <a href="AFDF.html#b0d0">collided_set_delay</a></td>
<td class="comment-1" rowspan="1">Jump to 'collided_set_delay'</td>
</tr>
<tr>
<td class="asm-label">collision_17</td>
<td class="address-2"><span id="b0f2"></span>B0F2</td>
<td class="instruction">SET 5,(IY+$07)</td>
<td class="comment-1" rowspan="1">IY-&gt;counter_and_flags |= vischar_BYTE7_Y_DOMINAN</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0f6"></span>B0F6</td>
<td class="instruction">JR <a href="AFDF.html#b0d0">collided_set_delay</a></td>
<td class="comment-1" rowspan="1">Jump to 'collided_set_delay'</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b0f8"></span>
<div class="comments">
<div class="paragraph">
Inputs which move the character in the next anticlockwise direction.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">collision_new_inputs</td>
<td class="address-1"><span id="b0f8"></span>B0F8</td>
<td class="instruction">DEFB $85</td>
<td class="comment-1" rowspan="1">= input_(DOWN+LEFT +KICK) =&gt; if facing TL, move D+L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0f9"></span>B0F9</td>
<td class="instruction">DEFB $84</td>
<td class="comment-1" rowspan="1">= input_(UP  +LEFT +KICK) =&gt; if facing TR, move U+L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0fa"></span>B0FA</td>
<td class="instruction">DEFB $87</td>
<td class="comment-1" rowspan="1">= input_(UP  +RIGHT+KICK) =&gt; if facing BR, move U+R</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0fb"></span>B0FB</td>
<td class="instruction">DEFB $88</td>
<td class="comment-1" rowspan="1">= input_(DOWN+RIGHT+KICK) =&gt; if facing BL, move D+R</td>
</tr>
<tr>
<td class="asm-label">collision_pop_next</td>
<td class="address-2"><span id="b0fc"></span>B0FC</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the vischar pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0fd"></span>B0FD</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the loop counter</td>
</tr>
<tr>
<td class="asm-label">collision_18</td>
<td class="address-2"><span id="b0fe"></span>B0FE</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="3">Step <span class="register">HL</span> to the next vischar</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b0ff"></span>B0FF</td>
<td class="instruction">ADD A,$20</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b101"></span>B101</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b102"></span>B102</td>
<td class="instruction">DEC B</td>
<td class="comment-1" rowspan="2">...loop for each vischar</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b103"></span>B103</td>
<td class="instruction">JP NZ,<a href="AFDF.html#afe4">collision_0</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b106"></span>B106</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return with Z set</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="AF8F.html">AF8F</a>
</td>
<td class="up">Up: <a href="../maps/all.html#afdf">Map</a></td>
<td class="next">
Next: <a href="B107.html">B107</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete The Great Escape disassembly 20240104</div>
<div class="copyright">&copy; 1986 Denton Designs &amp; Ocean Software Ltd. (The Great Escape). &copy; 2012-2024 David Thomas (this disassembly).</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.0.</div>
</footer>
</body>
</html>