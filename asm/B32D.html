<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at B32D</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="The Great Escape" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="B2FC.html">B2FC</a>
</td>
<td class="up">Up: <a href="../maps/all.html#b32d">Map</a></td>
<td class="next">
Next: <a href="B387.html">B387</a>
</td>
</tr>
</table>
<div class="description">B32D: Door handling (indoors).</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="B1F5.html">door_handling</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IY</td>
<td class="register-desc">Pointer to visible character.</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">door_handling_interior</td>
<td class="address-2"><span id="b32d"></span>B32D</td>
<td class="instruction">LD HL,$81D6</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the interior_doors array</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b330"></span>
<div class="comments">
<div class="paragraph">
Loop through every door index in interior_doors.
</div>
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">door_handling_interior_0</td>
<td class="address-2"><span id="b330"></span>B330</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch a door index</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b331"></span>B331</td>
<td class="instruction">CP $FF</td>
<td class="comment-1" rowspan="1">Does it equal door_NONE? ($FF)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b333"></span>B333</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">If so, we've reached the end of the list - return</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b334"></span>B334</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Switch register banks until the end of this iteration</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b335"></span>B335</td>
<td class="instruction">LD ($68A1),A</td>
<td class="comment-1" rowspan="1">Set the global current door to door index</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b338"></span>B338</td>
<td class="instruction">CALL <a href="6A12.html">get_door</a></td>
<td class="comment-1" rowspan="1">Turn the door_index into a door_t structure pointer in <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b33b"></span>B33B</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="2">Fetch room_and_flags from the door_t and save in <span class="register">C</span> for later</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b33c"></span>B33C</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b33d"></span>
<div class="comments">
<div class="paragraph">
Does the character face the same direction as the door?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b33d"></span>B33D</td>
<td class="instruction">AND $03</td>
<td class="comment-1" rowspan="1">Mask off the door's direction part (door_FLAGS_MASK_DIRECTION)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b33f"></span>B33F</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Stash it in <span class="register">B</span> for a comparison in a moment</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b340"></span>B340</td>
<td class="instruction">LD A,(IY+$0E)</td>
<td class="comment-1" rowspan="1">Fetch IY's direction &amp; crawl byte</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b343"></span>B343</td>
<td class="instruction">AND $03</td>
<td class="comment-1" rowspan="1">Mask off the direction part (vischar_DIRECTION_MASK)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b345"></span>B345</td>
<td class="instruction">CP B</td>
<td class="comment-1" rowspan="1">Do the door and vischar have the same direction?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b346"></span>B346</td>
<td class="instruction">JR NZ,<a href="B32D.html#b383">dhi_next</a></td>
<td class="comment-1" rowspan="1">Jump to the next iteration if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b348"></span>
<div class="comments">
<div class="paragraph">
Skip any door which is more than three units away.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b348"></span>B348</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to point at door's position</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b349"></span>B349</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Move it into <span class="register">DE</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b34a"></span>
<div class="comments">
<div class="paragraph">
TODO: Does this treat saved_pos as 8-bit quantities? (it's normally 16-bit)
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b34a"></span>B34A</td>
<td class="instruction">LD HL,$81A4</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at saved_pos_x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b34d"></span>B34D</td>
<td class="instruction">LD B,$02</td>
<td class="comment-1" rowspan="1">Iterate twice: X,Y axis</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b34f"></span>
<div class="comments">
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">door_handling_interior_1</td>
<td class="address-2"><span id="b34f"></span>B34F</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Fetch door position x/y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b350"></span>B350</td>
<td class="instruction">SUB $03</td>
<td class="comment-1" rowspan="1">Subtract 3 to form lower bound (pos-3)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b352"></span>B352</td>
<td class="instruction">CP (HL)</td>
<td class="comment-1" rowspan="1">Compare to saved_pos_x/y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b353"></span>B353</td>
<td class="instruction">JR NC,<a href="B32D.html#b383">dhi_next</a></td>
<td class="comment-1" rowspan="1">If lower bound &gt;= saved_pos goto next</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b355"></span>B355</td>
<td class="instruction">ADD A,$06</td>
<td class="comment-1" rowspan="1">Add 6 to form upper bound (pos+3)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b357"></span>B357</td>
<td class="instruction">CP (HL)</td>
<td class="comment-1" rowspan="1">Compare to saved_pos_x/y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b358"></span>B358</td>
<td class="instruction">JR C,<a href="B32D.html#b383">dhi_next</a></td>
<td class="comment-1" rowspan="1">If upper bound &lt; saved_pos goto next</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b35a"></span>B35A</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="2">Step to the next saved_pos axis</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b35b"></span>B35B</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b35c"></span>B35C</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Step to the next door position axis</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b35d"></span>B35D</td>
<td class="instruction">DJNZ <a href="B32D.html#b34f">door_handling_interior_1</a></td>
<td class="comment-1" rowspan="1">...loop</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b35f"></span>B35F</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Skip position height byte</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b360"></span>B360</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Move door position back into <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b361"></span>B361</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Preserve door position pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b362"></span>B362</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Preserve iteration counter</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b363"></span>B363</td>
<td class="instruction">CALL <a href="B1D4.html">is_door_locked</a></td>
<td class="comment-1" rowspan="1">Locate current door. Returns Z set if door is open</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b366"></span>B366</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore iteration counter</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b367"></span>B367</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore door position pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b368"></span>B368</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if Z clear =&gt; the door was locked</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b369"></span>
<div class="comments">
<div class="paragraph">
The door is in range and is unlocked - proceed with transition.
</div>
<div class="paragraph">
Set the vischar's room to the door's destination.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b369"></span>B369</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">Retrieve the room_and_flags we saved earlier</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b36a"></span>B36A</td>
<td class="instruction">RRA</td>
<td class="comment-1" rowspan="3">Discard the direction bits so it's room index only</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b36b"></span>B36B</td>
<td class="instruction">RRA</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b36c"></span>B36C</td>
<td class="instruction">AND $3F</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b36e"></span>B36E</td>
<td class="instruction">LD (IY+$1C),A</td>
<td class="comment-1" rowspan="1">Store it in vischar-&gt;room</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="b371"></span>
<div class="comments">
<div class="paragraph">
Get the destination position for transition.
</div>
<div class="paragraph">
If we're going through the door in the forward direction we fetch our destination position from the next element in the list. If we're reversed we fetch the previous element in the list.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b371"></span>B371</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Point at the next door position</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b372"></span>B372</td>
<td class="instruction">LD A,($68A1)</td>
<td class="comment-1" rowspan="1">Fetch the global current door</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b375"></span>B375</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-1" rowspan="1">Is door_REVERSE set?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b377"></span>B377</td>
<td class="instruction">JR Z,<a href="B32D.html#b380">door_handling_interior_2</a></td>
<td class="comment-1" rowspan="1">Jump if so. <span class="register">HL</span> is setup for transition call</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b379"></span>B379</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="5">Subtract 8 from <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b37a"></span>B37A</td>
<td class="instruction">SUB $08</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b37c"></span>B37C</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b37d"></span>B37D</td>
<td class="instruction">JR NC,<a href="B32D.html#b380">door_handling_interior_2</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b37f"></span>B37F</td>
<td class="instruction">DEC H</td>
</tr>
<tr>
<td class="asm-label">door_handling_interior_2</td>
<td class="address-2"><span id="b380"></span>B380</td>
<td class="instruction">JP <a href="68A2.html">transition</a></td>
<td class="comment-1" rowspan="1">Jump to transition -- never returns</td>
</tr>
<tr>
<td class="asm-label">dhi_next</td>
<td class="address-2"><span id="b383"></span>B383</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Unbank</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b384"></span>B384</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance to the next door in interior_doors[]</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="b385"></span>B385</td>
<td class="instruction">JR <a href="B32D.html#b330">door_handling_interior_0</a></td>
<td class="comment-1" rowspan="1">...loop</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="B2FC.html">B2FC</a>
</td>
<td class="up">Up: <a href="../maps/all.html#b32d">Map</a></td>
<td class="next">
Next: <a href="B387.html">B387</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete The Great Escape disassembly 20200812</div>
<div class="copyright">&copy; 1986 Denton Designs &amp; Ocean Software Ltd. (The Great Escape). &copy; 2012-2020 David Thomas (this disassembly).</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
</footer>
</body>
</html>