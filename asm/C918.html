<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at C918</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="The Great Escape" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="C892.html">C892</a>
</td>
<td class="up">Up: <a href="../maps/all.html#c918">Map</a></td>
<td class="next">
Next: <a href="CA11.html">CA11</a>
</td>
</tr>
</table>
<div class="description">C918: Character behaviour</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
This handles the various different pursuit modes that vischars can be in (pursuing the hero, a dog moving towards food, etc.) and drives character movement.
</div>
<div class="paragraph">
Used by the routines at <a href="C4E0.html">spawn_character</a> and <a href="C892.html">automatics</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IY</td>
<td class="register-desc">Pointer to visible character.</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c918"></span>
<div class="comments">
<div class="paragraph">
Proceed into the character behaviour handling only when this delay field hits zero. This stops characters navigating around obstacles too quickly.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">character_behaviour</td>
<td class="address-2"><span id="c918"></span>C918</td>
<td class="instruction">LD A,(IY+$07)</td>
<td class="comment-1" rowspan="1">Fetch vischar.counter_and_flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c91b"></span>C91B</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Copy it to <span class="register">B</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c91c"></span>
<div class="comments">
<div class="paragraph">
If the counter field is set then decrement it and return.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c91c"></span>C91C</td>
<td class="instruction">AND $0F</td>
<td class="comment-1" rowspan="1">Isolate the counter field in the bottom nibble</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c91e"></span>C91E</td>
<td class="instruction">JR Z,<a href="C918.html#c925">cb_proceed</a></td>
<td class="comment-1" rowspan="3">Decrement the counter if it's positive</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c920"></span>C920</td>
<td class="instruction">DEC B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c921"></span>C921</td>
<td class="instruction">LD (IY+$07),B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c924"></span>C924</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c925"></span>
<div class="comments">
<div class="paragraph">
We arrive here when the counter is zero.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">cb_proceed</td>
<td class="address-2"><span id="c925"></span>C925</td>
<td class="instruction">PUSH IY</td>
<td class="comment-1" rowspan="2">Copy the vischar pointer into <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c927"></span>C927</td>
<td class="instruction">POP HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c928"></span>C928</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to vischar.flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c929"></span>C929</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch the flags so we can check the mode field</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c92a"></span>C92A</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Are any flag bits set?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c92b"></span>C92B</td>
<td class="instruction">JP Z,<a href="C918.html#c9ba">cb_check_halt</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c92e"></span>
<div class="comments">
<div class="paragraph">
Check for mode 1 ("pursue")
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c92e"></span>C92E</td>
<td class="instruction">CP $01</td>
<td class="comment-1" rowspan="1">Is the mode vischar_PURSUIT_PURSUE?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c930"></span>C930</td>
<td class="instruction">JR NZ,<a href="C918.html#c943">cb_hassle_check</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c932"></span>
<div class="comments">
<div class="paragraph">
Mode 1: Hero is chased by hostiles and sent to solitary if caught.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">cb_pursue_hero</td>
<td class="address-2"><span id="c932"></span>C932</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Preserve vischar.flags pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c933"></span>C933</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Bank</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c934"></span>C934</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore vischar.flags pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c935"></span>C935</td>
<td class="instruction">INC E</td>
<td class="comment-1" rowspan="3">Advance <span class="register">DE</span> to vischar.position</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c936"></span>C936</td>
<td class="instruction">INC E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c937"></span>C937</td>
<td class="instruction">INC E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c938"></span>C938</td>
<td class="instruction">LD HL,$81B8</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the global map position (the hero's position)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c93b"></span>C93B</td>
<td class="instruction">LDI</td>
<td class="comment-1" rowspan="2">Copy hero's (x,y) position to vischar.target</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c93d"></span>C93D</td>
<td class="instruction">LDI</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c93f"></span>C93F</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Unbank</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c940"></span>C940</td>
<td class="instruction">JP <a href="C918.html#c9c0">cb_move</a></td>
<td class="comment-1" rowspan="1">Jump to 'move'</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c943"></span>
<div class="comments">
<div class="paragraph">
Check for mode 2 ("hassle")
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">cb_hassle_check</td>
<td class="address-2"><span id="c943"></span>C943</td>
<td class="instruction">CP $02</td>
<td class="comment-1" rowspan="1">Is the mode vischar_PURSUIT_HASSLE?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c945"></span>C945</td>
<td class="instruction">JR NZ,<a href="C918.html#c953">cb_dog_food_check</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c947"></span>
<div class="comments">
<div class="paragraph">
Mode 2: Hero is chased by hostiles if under player control.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c947"></span>C947</td>
<td class="instruction">LD A,($A139)</td>
<td class="comment-1" rowspan="2">Is the automatic_player_counter non-zero?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c94a"></span>C94A</td>
<td class="instruction">AND A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c94b"></span>
<div class="comments">
<div class="paragraph">
The hero is under player control: pursue.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c94b"></span>C94B</td>
<td class="instruction">JR NZ,<a href="C918.html#c932">cb_pursue_hero</a></td>
<td class="comment-1" rowspan="1">Jump into mode 1's pursue handler</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c94d"></span>
<div class="comments">
<div class="paragraph">
Otherwise the hero is under automatic control: hostiles lose interest and resume their original route.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c94d"></span>C94D</td>
<td class="instruction">LD (HL),$00</td>
<td class="comment-1" rowspan="2">Clear vischar.flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c94f"></span>C94F</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c950"></span>C950</td>
<td class="instruction">JP <a href="CB23.html">get_target_assign_pos</a></td>
<td class="comment-1" rowspan="1">Exit via get_target_assign_pos</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c953"></span>
<div class="comments">
<div class="paragraph">
Check for mode 3 ("dog food")
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">cb_dog_food_check</td>
<td class="address-2"><span id="c953"></span>C953</td>
<td class="instruction">CP $03</td>
<td class="comment-1" rowspan="1">Is the mode vischar_PURSUIT_DOG_FOOD?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c955"></span>C955</td>
<td class="instruction">JR NZ,<a href="C918.html#c979">cb_saw_bribe_check</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c957"></span>
<div class="comments">
<div class="paragraph">
Mode 3: The food item is near a guard dog.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c957"></span>C957</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Preserve vischar.flags pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c958"></span>C958</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">(get it in <span class="register">DE</span>)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c959"></span>C959</td>
<td class="instruction">LD HL,$76FA</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at item_structs[item_FOOD].room</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c95c"></span>C95C</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">Is itemstruct_ROOM_FLAG_NEARBY_7 set?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c95e"></span>C95E</td>
<td class="instruction">JR Z,<a href="C918.html#c96c">cb_dog_food_not_nearby</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c960"></span>
<div class="comments">
<div class="paragraph">
Set the dog's target to the poisoned food location.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c960"></span>C960</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to item_structs[item_FOOD].pos.x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c961"></span>C961</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="3">Point <span class="register">DE</span> at vischar.target.x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c962"></span>C962</td>
<td class="instruction">ADD A,$03</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c964"></span>C964</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c965"></span>C965</td>
<td class="instruction">LDI</td>
<td class="comment-1" rowspan="2">Copy (x,y)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c967"></span>C967</td>
<td class="instruction">LDI</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c969"></span>C969</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore vischar.flags pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c96a"></span>C96A</td>
<td class="instruction">JR <a href="C918.html#c9c0">cb_move</a></td>
<td class="comment-1" rowspan="1">Jump to 'move'</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c96c"></span>
<div class="comments">
<div class="paragraph">
Nearby flag wasn't set.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">cb_dog_food_not_nearby</td>
<td class="address-2"><span id="c96c"></span>C96C</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Clear vischar.flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c96d"></span>C96D</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c96e"></span>C96E</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">(get vischar.flags pointer in <span class="register">HL</span>)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c96f"></span>C96F</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="2">Set vischar.route.index to routeindex_255_WANDER ($FF)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c970"></span>C970</td>
<td class="instruction">LD (HL),$FF</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c972"></span>C972</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="2">Set vischar.route.step to zero -- wander from 0..7</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c973"></span>C973</td>
<td class="instruction">LD (HL),$00</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c975"></span>C975</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore vischar.flags pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c976"></span>C976</td>
<td class="instruction">JP <a href="CB23.html">get_target_assign_pos</a></td>
<td class="comment-1" rowspan="1">Exit via get_target_assign_pos</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c979"></span>
<div class="comments">
<div class="paragraph">
Check for mode 4 ("saw bribe")
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">cb_saw_bribe_check</td>
<td class="address-2"><span id="c979"></span>C979</td>
<td class="instruction">CP $04</td>
<td class="comment-1" rowspan="1">Is the mode vischar_PURSUIT_SAW_BRIBE?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c97b"></span>C97B</td>
<td class="instruction">JR NZ,<a href="C918.html#c9ba">cb_check_halt</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c97d"></span>
<div class="comments">
<div class="paragraph">
Mode 4: Hostile character witnessed a bribe being given (in accept_bribe).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c97d"></span>C97D</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Preserve vischar.flags pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c97e"></span>C97E</td>
<td class="instruction">LD A,($AF8E)</td>
<td class="comment-1" rowspan="1">Get the global bribed character</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c981"></span>C981</td>
<td class="instruction">CP $FF</td>
<td class="comment-1" rowspan="1">Is it character_NONE? ($FF)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c983"></span>C983</td>
<td class="instruction">JR Z,<a href="C918.html#c995">cb_bribe_not_found</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c985"></span>C985</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Copy the bribed character to <span class="register">C</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c986"></span>
<div class="comments">
<div class="paragraph">
Iterate over non-player characters.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c986"></span>C986</td>
<td class="instruction">LD B,$07</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> for seven iterations</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c988"></span>C988</td>
<td class="instruction">LD HL,$8020</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the second visible character</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c98b"></span>
<div class="comments">
<div class="paragraph">
Start loop
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">cb_bribe_loop</td>
<td class="address-2"><span id="c98b"></span>C98B</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">Copy bribed character to <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c98c"></span>C98C</td>
<td class="instruction">CP (HL)</td>
<td class="comment-1" rowspan="1">Is this vischar the bribed character?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c98d"></span>C98D</td>
<td class="instruction">JR Z,<a href="C918.html#c99c">cb_bribed_visible</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c98f"></span>C98F</td>
<td class="instruction">LD A,$20</td>
<td class="comment-1" rowspan="3">Step <span class="register">HL</span> to the next vischar</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c991"></span>C991</td>
<td class="instruction">ADD A,L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c992"></span>C992</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c993"></span>C993</td>
<td class="instruction">DJNZ <a href="C918.html#c98b">cb_bribe_loop</a></td>
<td class="comment-1" rowspan="1">...loop</td>
</tr>
<tr>
<td class="asm-label">cb_bribe_not_found</td>
<td class="address-2"><span id="c995"></span>C995</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore vischar.flags pointer</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c996"></span>
<div class="comments">
<div class="paragraph">
Bribed character was not visible: hostiles lose interest and resume following their original route.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c996"></span>C996</td>
<td class="instruction">LD (HL),$00</td>
<td class="comment-1" rowspan="2">Clear vischar.flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c998"></span>C998</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c999"></span>C999</td>
<td class="instruction">JP <a href="CB23.html">get_target_assign_pos</a></td>
<td class="comment-1" rowspan="1">Exit via get_target_assign_pos</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c99c"></span>
<div class="comments">
<div class="paragraph">
Found the bribed character in vischars: hostiles target him.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">cb_bribed_visible</td>
<td class="address-2"><span id="c99c"></span>C99C</td>
<td class="instruction">LD A,$0F</td>
<td class="comment-1" rowspan="3">Advance <span class="register">HL</span> to vischar.mi.pos</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c99e"></span>C99E</td>
<td class="instruction">ADD A,L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c99f"></span>C99F</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9a0"></span>C9A0</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="2">Get the vischar pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9a1"></span>C9A1</td>
<td class="instruction">PUSH DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9a2"></span>C9A2</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="3">Point <span class="register">DE</span> at vischar.target</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9a3"></span>C9A3</td>
<td class="instruction">ADD A,$03</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9a5"></span>C9A5</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9a6"></span>C9A6</td>
<td class="instruction">LD A,($68A0)</td>
<td class="comment-1" rowspan="1">Get the global current room index</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9a9"></span>C9A9</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is it zero?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9aa"></span>C9AA</td>
<td class="instruction">JP NZ,<a href="C918.html#c9b2">cb_bribed_indoors</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c9ad"></span>
<div class="comments">
<div class="paragraph">
Outdoors
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9ad"></span>C9AD</td>
<td class="instruction">CALL <a href="E542.html">pos_to_tinypos</a></td>
<td class="comment-1" rowspan="1">Scale down the bribed character's position to this vischar's target field</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9b0"></span>C9B0</td>
<td class="instruction">JR <a href="C918.html#c9b7">cb_bribed_done</a></td>
<td class="comment-1" rowspan="1">(else)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c9b2"></span>
<div class="comments">
<div class="paragraph">
Indoors
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">cb_bribed_indoors</td>
<td class="address-2"><span id="c9b2"></span>C9B2</td>
<td class="instruction">LDI</td>
<td class="comment-1" rowspan="3">Scale down the bribed character's position to this vischar's target field</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9b4"></span>C9B4</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9b5"></span>C9B5</td>
<td class="instruction">LDI</td>
</tr>
<tr>
<td class="asm-label">cb_bribed_done</td>
<td class="address-2"><span id="c9b7"></span>C9B7</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the vischar pointer</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9b8"></span>C9B8</td>
<td class="instruction">JR <a href="C918.html#c9c0">cb_move</a></td>
<td class="comment-1" rowspan="1">Jump to 'move'</td>
</tr>
<tr>
<td class="asm-label">cb_check_halt</td>
<td class="address-2"><span id="c9ba"></span>C9BA</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to vischar.route.index</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9bb"></span>C9BB</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch it</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9bc"></span>C9BC</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="1">Step back</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9bd"></span>C9BD</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is it routeindex_0_HALT? ($00)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9be"></span>C9BE</td>
<td class="instruction">JR Z,<a href="C918.html#c9f5">cb_set_input</a></td>
<td class="comment-1" rowspan="1">Jump if so (set input)</td>
</tr>
<tr>
<td class="asm-label">cb_move</td>
<td class="address-2"><span id="c9c0"></span>C9C0</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Get vischar.flags</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9c1"></span>C9C1</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Bank</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9c2"></span>C9C2</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1"><span class="register">C</span> = flags</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c9c3"></span>
<div class="comments">
<div class="paragraph">
Select a scaling routine.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9c3"></span>C9C3</td>
<td class="instruction">LD A,($68A0)</td>
<td class="comment-1" rowspan="1">Get the global current room index</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9c6"></span>C9C6</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is it outdoors? (zero)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9c7"></span>C9C7</td>
<td class="instruction">JR Z,<a href="C918.html#c9ce">cb_scaling_door</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label">cb_scaling_indoors</td>
<td class="address-1"><span id="c9c9"></span>C9C9</td>
<td class="instruction">LD HL,$CB75</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at multiply_by_1</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9cc"></span>C9CC</td>
<td class="instruction">JR <a href="C918.html#c9da">cb_self_modify</a></td>
<td class="comment-1" rowspan="1">(else)</td>
</tr>
<tr>
<td class="asm-label">cb_scaling_door</td>
<td class="address-2"><span id="c9ce"></span>C9CE</td>
<td class="instruction">BIT 6,C</td>
<td class="comment-1" rowspan="1">Is vischar.flags vischar_FLAGS_TARGET_IS_DOOR set?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9d0"></span>C9D0</td>
<td class="instruction">JR Z,<a href="C918.html#c9d7">cb_scaling_outdoors</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9d2"></span>C9D2</td>
<td class="instruction">LD HL,$B295</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at multiply_by_4</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9d5"></span>C9D5</td>
<td class="instruction">JR <a href="C918.html#c9da">cb_self_modify</a></td>
<td class="comment-1" rowspan="1">(else)</td>
</tr>
<tr>
<td class="asm-label">cb_scaling_outdoors</td>
<td class="address-2"><span id="c9d7"></span>C9D7</td>
<td class="instruction">LD HL,$B1C7</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at multiply_by_8</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c9da"></span>
<div class="comments">
<div class="paragraph">
Self modify vischar_move_x/y routines.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">cb_self_modify</td>
<td class="address-2"><span id="c9da"></span>C9DA</td>
<td class="instruction">LD ($CA13),HL</td>
<td class="comment-1" rowspan="1">Self-modify vischar_move_x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9dd"></span>C9DD</td>
<td class="instruction">LD ($CA4B),HL</td>
<td class="comment-1" rowspan="1">Self-modify vischar_move_y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9e0"></span>C9E0</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Unbank</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c9e1"></span>
<div class="comments">
<div class="paragraph">
If the vischar_BYTE7_Y_DOMINANT flag is set then <a href="C918.html#c9ff">cb_move_y_dominant</a> is used instead of the code below, which is x dominant. i.e. It means "try moving y then x, rather than x then y". This is the code which makes characters alternate left/right when navigating.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9e1"></span>C9E1</td>
<td class="instruction">BIT 5,(IY+$07)</td>
<td class="comment-1" rowspan="1">Does the vischar's counter_and_flags field have flag vischar_BYTE7_Y_DOMINANT set? ($20)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9e5"></span>C9E5</td>
<td class="instruction">JR NZ,<a href="C918.html#c9ff">cb_move_y_dominant</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label">cb_move_x_dominant</td>
<td class="address-1"><span id="c9e7"></span>C9E7</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="3">Advance <span class="register">HL</span> to vischar.position.x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9e8"></span>C9E8</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9e9"></span>C9E9</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9ea"></span>C9EA</td>
<td class="instruction">CALL <a href="CA11.html">vischar_move_x</a></td>
<td class="comment-1" rowspan="1">Call vischar_move_x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9ed"></span>C9ED</td>
<td class="instruction">JR NZ,<a href="C918.html#c9f5">cb_set_input</a></td>
<td class="comment-1" rowspan="2">If it couldn't move call vischar_move_y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9ef"></span>C9EF</td>
<td class="instruction">CALL <a href="CA49.html">vischar_move_y</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9f2"></span>C9F2</td>
<td class="instruction">JP Z,<a href="CA81.html">target_reached</a></td>
<td class="comment-1" rowspan="1">If it still couldn't move exit via target_reached</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c9f5"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="CA81.html">target_reached</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">cb_set_input</td>
<td class="address-2"><span id="c9f5"></span>C9F5</td>
<td class="instruction">CP (IY+$0D)</td>
<td class="comment-1" rowspan="1">Is our new input different from the vischar's existing input?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9f8"></span>C9F8</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9f9"></span>C9F9</td>
<td class="instruction">OR $80</td>
<td class="comment-1" rowspan="2">Otherwise set the input_KICK flag</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9fb"></span>C9FB</td>
<td class="instruction">LD (IY+$0D),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c9fe"></span>C9FE</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
<tr>
<td class="asm-label">cb_move_y_dominant</td>
<td class="address-2"><span id="c9ff"></span>C9FF</td>
<td class="instruction">LD A,$04</td>
<td class="comment-1" rowspan="3">Advance <span class="register">HL</span> to vischar.position.y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="ca01"></span>CA01</td>
<td class="instruction">ADD A,L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="ca02"></span>CA02</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="ca03"></span>CA03</td>
<td class="instruction">CALL <a href="CA49.html">vischar_move_y</a></td>
<td class="comment-1" rowspan="1">Call vischar_move_y</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="ca06"></span>CA06</td>
<td class="instruction">JR NZ,<a href="C918.html#c9f5">cb_set_input</a></td>
<td class="comment-1" rowspan="2">If it couldn't move call vischar_move_x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="ca08"></span>CA08</td>
<td class="instruction">CALL <a href="CA11.html">vischar_move_x</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="ca0b"></span>CA0B</td>
<td class="instruction">JR NZ,<a href="C918.html#c9f5">cb_set_input</a></td>
<td class="comment-1" rowspan="1">If it could move, jump to cb_set_input</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="ca0d"></span>CA0D</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="1">Rewind <span class="register">HL</span> to vischar.position.x</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="ca0e"></span>CA0E</td>
<td class="instruction">JP <a href="CA81.html">target_reached</a></td>
<td class="comment-1" rowspan="1">Exit via target_reached</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="C892.html">C892</a>
</td>
<td class="up">Up: <a href="../maps/all.html#c918">Map</a></td>
<td class="next">
Next: <a href="CA11.html">CA11</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete The Great Escape disassembly 20240104</div>
<div class="copyright">&copy; 1986 Denton Designs &amp; Ocean Software Ltd. (The Great Escape). &copy; 2012-2024 David Thomas (this disassembly).</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.0.</div>
</footer>
</body>
</html>